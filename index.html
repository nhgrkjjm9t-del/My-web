<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Shop - Admin Live Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, update, onValue, remove, push, onChildAdded, onChildChanged, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC5zPaTAAU5lPCZ7LstSQ8J9IWmkQrpcMg",
            authDomain: "tiktokshop-9fd63.firebaseapp.com",
            projectId: "tiktokshop-9fd63",
            storageBucket: "tiktokshop-9fd63.firebasestorage.app",
            messagingSenderId: "1008538085856",
            appId: "1:1008538085856:web:83caa9dc0d7444e12c2385",
            measurementId: "G-1NSG64V4D4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.db = db;
        window.ref = ref;
        window.set = set;
        window.get = get;
        window.update = update;
        window.remove = remove;
        window.onValue = onValue;
        window.push = push;
        window.onChildAdded = onChildAdded;
        window.onChildChanged = onChildChanged;

        console.log("System Ready");
        initializeAppLogic();
    </script>

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f3f4f6; user-select: none; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #FCD34D; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .nav-item.active { color: #000; }
        .nav-item { color: #9ca3af; transition: all 0.3s; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; display: flex; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; position: relative; max-height: 90vh; overflow-y: auto; }
        
        .admin-table th { background-color: #1f2937; color: #fbbf24; padding: 8px; font-size: 11px; }
        .admin-table td { padding: 8px; border-bottom: 1px solid #374151; font-size: 12px; color: white; }
        .admin-btn { padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; margin: 1px; cursor: pointer; transition: 0.2s; }
        .admin-btn:hover { opacity: 0.8; }
        
        .frozen-overlay { background: rgba(255, 255, 255, 0.95); position: absolute; top:0; left:0; width:100%; height:100%; z-index: 10; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 1rem; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .ticker-item { animation: slideIn 0.5s ease-out; border-bottom: 1px dashed #eee; padding-bottom: 2px; }
        
        @keyframes swing { 0%, 100% { transform: rotate(0deg); } 20% { transform: rotate(15deg); } 40% { transform: rotate(-10deg); } 60% { transform: rotate(5deg); } 80% { transform: rotate(-5deg); } }
        .animate-swing { animation: swing 1s ease-in-out infinite; }
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }

        .admin-toast {
            background: #1f2937; border-right: 4px solid #FCD34D; color: white;
            padding: 15px; margin-bottom: 10px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 10px;
            animation: slideLeft 0.5s ease-out;
            min-width: 300px;
        }
        @keyframes slideLeft { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>

    <div id="notification-toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-900/95 backdrop-blur text-white px-5 py-3 rounded-full shadow-2xl z-[100] hidden flex items-center gap-3 transition-all duration-500 border border-yellow-500 w-[90%] max-w-sm">
        <div class="bg-yellow-500 rounded-full p-2 text-black"><i class="fa-solid fa-bell animate-swing"></i></div>
        <div class="flex-1 text-right">
            <p class="text-[10px] text-gray-400 font-bold mb-0.5">ØªØ°ÙƒÙŠØ± Ù‡Ø§Ù… ğŸ””</p>
            <p id="notif-text" class="text-xs font-bold leading-tight">...</p>
        </div>
    </div>

    <div id="admin-alerts-container" class="fixed bottom-5 left-5 z-[200] flex flex-col items-start gap-2"></div>

    <div id="loading-overlay" class="fixed inset-0 bg-white z-[99] flex flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <p class="text-sm text-gray-500 font-bold">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</p>
    </div>

    <div id="auth-screen" class="min-h-screen flex flex-col items-center justify-center bg-white p-6 hidden relative z-50">
        <div class="mb-6 text-center">
            <i class="fa-brands fa-tiktok text-6xl text-black mb-2"></i>
            <h1 class="text-2xl font-bold tracking-wider">TikTok Shop</h1>
        </div>
        <div class="flex w-full max-w-sm mb-6 bg-gray-100 rounded-lg p-1">
            <button onclick="toggleAuth('login')" id="tab-login" class="flex-1 py-2 rounded-md font-bold text-sm bg-white shadow-sm transition">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
            <button onclick="toggleAuth('register')" id="tab-register" class="flex-1 py-2 rounded-md font-bold text-sm text-gray-500 transition">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
        </div>
        
        <div id="login-form" class="w-full max-w-sm space-y-4 fade-in">
            <input type="text" id="login-phone" class="w-full p-3 border border-gray-200 rounded-xl bg-gray-50 text-right focus:border-black outline-none" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
            <input type="password" id="login-pass" class="w-full p-3 border border-gray-200 rounded-xl bg-gray-50 text-right focus:border-black outline-none" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button onclick="loginUser()" class="w-full bg-black text-white py-3 rounded-xl font-bold shadow-lg hover:bg-gray-800 transition active:scale-95">Ø¯Ø®ÙˆÙ„</button>
        </div>

        <div id="reg-form" class="w-full max-w-sm space-y-3 hidden fade-in">
            <div id="reg-step-1">
                <label class="block text-right text-gray-500 text-sm mb-1 font-bold">Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                <input type="number" id="reg-phone" class="w-full p-3 border border-gray-200 rounded-xl bg-gray-50 text-right mb-3" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ">
                <button onclick="sendOtp()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition">Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ (SMS)</button>
            </div>
            <div id="reg-step-2" class="hidden">
                <label class="block text-right text-gray-500 text-sm mb-1 font-bold">Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯</label>
                <div class="bg-yellow-50 p-2 rounded text-xs text-yellow-800 mb-2 text-right">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ©</div>
                <input type="number" id="reg-otp-input" class="w-full p-3 border border-gray-200 rounded-xl bg-gray-50 text-center tracking-widest text-xl font-bold" placeholder="XXXX">
                <button onclick="verifyOtp()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-green-700 transition mt-2">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯</button>
                <button onclick="resendOtp()" class="w-full text-gray-400 text-xs mt-2 underline">Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
            <div id="reg-step-3" class="hidden">
                <label class="block text-right text-gray-500 text-sm mb-1 font-bold">Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</label>
                <input type="text" id="reg-name" class="w-full p-3 border border-gray-200 rounded-xl bg-gray-50 text-right mb-2" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
                <div class="mb-2"><label class="block text-right text-xs text-gray-400 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label><input type="date" id="reg-dob" class="w-full p-3 border border-gray-200 rounded-xl bg-gray-50 text-right text-gray-600"></div>
                <input type="password" id="reg-pass" class="w-full p-3 border border-gray-200 rounded-xl bg-gray-50 text-right mb-2" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <input type="password" id="reg-pass-confirm" class="w-full p-3 border border-gray-200 rounded-xl bg-gray-50 text-right mb-4" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <button onclick="completeRegistration()" class="w-full bg-[#FCD34D] text-[#5D4037] py-3 rounded-xl font-bold shadow-lg hover:bg-yellow-400 transition active:scale-95">Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
            </div>
        </div>
    </div>

    <div id="admin-panel" class="hidden min-h-screen bg-gray-900 text-white p-4">
        <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
            <div>
                <h2 class="text-xl font-bold text-yellow-500">Admin Control</h2>
                <div class="flex items-center gap-2 mt-1"><div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div><p class="text-xs text-green-400">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙŠØ¹Ù…Ù„ ğŸ”´</p></div>
            </div>
            <button onclick="logout()" class="text-xs bg-red-600 px-3 py-2 rounded font-bold hover:bg-red-700">Ø®Ø±ÙˆØ¬</button>
        </div>

        <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
            <button onclick="showAdminTab('users')" id="btn-tab-users" class="flex-1 bg-yellow-600 py-2 px-4 rounded text-xs font-bold whitespace-nowrap">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
            <button onclick="showAdminTab('tasks')" id="btn-tab-tasks" class="flex-1 bg-gray-700 py-2 px-4 rounded text-xs font-bold whitespace-nowrap">Ø§Ù„Ù…Ù‡Ø§Ù…</button>
            <button onclick="showAdminTab('signatures')" id="btn-tab-signatures" class="flex-1 bg-orange-600 py-2 px-4 rounded text-xs font-bold whitespace-nowrap">Ø§Ù„Ø¨Ø§Ù‚Ø§Øª</button>
            <button onclick="showAdminTab('requests')" id="btn-tab-requests" class="flex-1 bg-blue-600 py-2 px-4 rounded text-xs font-bold whitespace-nowrap">Ø§Ù„Ø´Ø­Ù†</button>
            <button onclick="showAdminTab('support')" id="btn-tab-support" class="flex-1 bg-purple-600 py-2 px-4 rounded text-xs font-bold whitespace-nowrap">Ø§Ù„Ø¯Ø¹Ù…</button>
            <button onclick="showAdminTab('settings')" id="btn-tab-settings" class="flex-1 bg-gray-700 py-2 px-4 rounded text-xs font-bold whitespace-nowrap">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>

        <div id="admin-users-sec" class="bg-gray-800 rounded-xl p-2 border border-blue-500/50 shadow-lg mb-6">
            <h3 class="font-bold text-blue-400 mb-2 px-2">Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-right admin-table">
                    <thead><tr><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                    <tbody id="admin-users-list"></tbody>
                </table>
            </div>
        </div>

        <div id="admin-tasks-sec" class="hidden bg-gray-800 rounded-xl p-4 border border-blue-500/50 shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-blue-400">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…</h3>
                <button onclick="saveAdminTasks()" class="bg-green-600 px-3 py-1 rounded text-xs font-bold">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
            </div>
            <div id="admin-tasks-container" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2 pb-10"></div>
        </div>

        <div id="admin-signatures-sec" class="hidden bg-gray-800 rounded-xl p-4 border border-blue-500/50 shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-orange-400">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø§Ù‚Ø§Øª (Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„ØµÙˆØ±)</h3>
                <button onclick="saveAdminSignatures()" class="bg-green-600 px-3 py-1 rounded text-xs font-bold">Ø­ÙØ¸ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª</button>
            </div>
            <div id="admin-signatures-container" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2 pb-10"></div>
            <button onclick="addNewSignature()" class="w-full bg-orange-600 py-2 rounded text-xs font-bold mt-4">+ Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        </div>

        <div id="admin-requests-sec" class="hidden bg-gray-800 rounded-xl p-2 border border-blue-500/50 shadow-lg mb-6">
            <h3 class="font-bold text-blue-400 mb-2 px-2">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù†</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-right admin-table">
                    <thead><tr><th>Ø§Ù„Ø§Ø³Ù… (Ø§Ù„Ø¥ÙŠØµØ§Ù„)</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙˆÙ„</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                    <tbody id="admin-requests-list"></tbody>
                </table>
            </div>
        </div>

        <div id="admin-support-sec" class="hidden bg-gray-800 rounded-xl p-2 border border-blue-500/50 shadow-lg mb-6">
            <h3 class="font-bold text-purple-400 mb-2 px-2">Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-right admin-table">
                    <thead><tr><th>Ø§Ù„Ù…Ø±Ø³Ù„</th><th>Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ù„Ø±Ø¯</th><th>ØªØ­ÙƒÙ…</th></tr></thead>
                    <tbody id="admin-support-list"></tbody>
                </table>
            </div>
        </div>

        <div id="admin-settings-sec" class="hidden bg-gray-800 rounded-xl p-4 border border-blue-500/50 shadow-lg">
            <div class="bg-gray-700 p-4 rounded-lg space-y-3">
                <label class="block text-sm text-gray-400">Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©:</label>
                <input type="text" id="setting-cash-number" class="w-full bg-gray-600 text-white p-2 rounded text-sm">
                <label class="block text-sm text-gray-400">Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹Ù…:</label>
                <input type="text" id="setting-support-link" class="w-full bg-gray-600 text-white p-2 rounded text-sm">
                <label class="block text-sm text-gray-400">Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª:</label>
                <input type="text" id="setting-announcement" class="w-full bg-gray-600 text-white p-2 rounded text-sm">
                <button onclick="saveSiteSettings()" class="w-full bg-green-600 py-2 rounded text-xs font-bold mt-4">Ø­ÙØ¸</button>
            </div>
        </div>
    </div>

    <div id="client-app" class="hidden relative pb-20">
        <div id="recharge-modal" class="modal-overlay hidden">
            <div class="modal-box">
                <button onclick="closeRechargeModal()" class="absolute top-2 left-3 text-2xl font-bold text-gray-700">&times;</button>
                <h3 class="text-xl font-bold mb-4 text-gray-800">Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯</h3>
                <div id="recharge-rejected-alert" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 hidden text-right"><strong class="font-bold block mb-1">ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨Ùƒ!</strong><span class="text-sm block" id="recharge-rejection-reason"></span></div>
                <div class="bg-yellow-50 p-3 rounded text-sm mb-4 text-yellow-800 font-bold border border-yellow-200">
                    <p class="mb-2">ÙŠØ±Ø¬Ù‰ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ø¹Ù„Ù‰ ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´:</p>
                    <div class="flex items-center justify-center gap-3 bg-white p-2 rounded-lg border border-yellow-300 shadow-sm mt-1">
                        <span id="recharge-admin-number" class="text-xl text-black font-mono font-bold tracking-wider">...</span>
                        <button onclick="copyToClipboard()" class="text-gray-500 hover:text-blue-600 transition" title="Ù†Ø³Ø®"><i id="copy-icon" class="fa-regular fa-copy text-xl"></i></button>
                    </div>
                </div>
                <input type="number" id="charge-amount" class="w-full p-2 border rounded mb-2 bg-gray-50 text-right" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬Ù†ÙŠÙ‡)">
                <input type="text" id="charge-name" class="w-full p-2 border rounded mb-2 bg-gray-50 text-right" placeholder="Ø§Ø³Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ø­ÙØ¸Ø© (Ø§Ù„Ù…Ø±Ø³Ù„)">
                <input type="text" id="charge-sender" class="w-full p-2 border rounded mb-2 bg-gray-50 text-right" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© (Ø§Ù„Ù…Ø±Ø³Ù„)">
                <input type="file" id="recharge-file-input" class="hidden" accept="image/*" onchange="handleFileUpload(this)">
                <div id="upload-container" class="border-2 border-dashed border-gray-300 p-4 rounded mb-4 cursor-pointer hover:bg-gray-50 transition" onclick="document.getElementById('recharge-file-input').click()">
                    <div id="upload-placeholder"><i class="fa-solid fa-image text-gray-400 text-2xl"></i><p class="text-xs text-gray-400 mt-1">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ø³ÙƒØ±ÙŠÙ† Ø§Ù„ØªØ­ÙˆÙŠÙ„</p></div>
                    <div id="upload-preview" class="hidden"><i class="fa-solid fa-check-circle text-green-500 text-3xl mb-1"></i><p class="text-xs text-green-600 font-bold">ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø©</p></div>
                </div>
                <button onclick="submitRechargeRequest()" class="w-full bg-black text-white py-3 rounded-lg font-bold shadow-lg">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
            </div>
        </div>

        <div id="home-page" class="fade-in min-h-screen bg-gray-50 p-4">
            <header class="flex justify-between items-center mb-4 pt-2">
                <i class="fa-regular fa-bell text-xl text-gray-600"></i>
                <div class="flex items-center gap-2"><span class="font-bold text-lg">TikTok Shop</span><i class="fa-brands fa-tiktok text-2xl text-black"></i></div>
                <i onclick="switchTab('support-page')" class="fa-solid fa-headset text-2xl text-purple-600 cursor-pointer hover:scale-110 transition"></i>
            </header>
            <div class="bg-blue-100 text-blue-800 text-center py-2 px-2 mb-4 shadow-sm text-sm font-bold rounded" id="announcement-bar"><span id="announcement-display-text">...</span></div>
            <div class="slider-container">
                <div class="slide active" style="background-image: url('https://images.unsplash.com/photo-1607082348824-0a96f2a4b9da?w=800&q=80');"><span class="slide-text">Ø£Ø­Ø¯Ø« ØµÙŠØ­Ø§Øª Ø§Ù„Ù…ÙˆØ¶Ø©</span></div>
                <div class="slide" style="background-image: url('https://images.unsplash.com/photo-1483985988355-763728e1935b?w=800&q=80');"><span class="slide-text">Ø®ØµÙˆÙ…Ø§Øª Ù‡Ø§Ø¦Ù„Ø©</span></div>
                <div class="slide" style="background-image: url('https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=800&q=80');"><span class="slide-text">Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</span></div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div onclick="openRechargeModal()" class="cursor-pointer bg-white p-4 rounded-xl shadow-sm text-center border border-gray-100 active:scale-95 transition"><div class="bg-blue-100 w-10 h-10 rounded-full flex items-center justify-center mx-auto mb-2 text-blue-600"><i class="fa-solid fa-money-bill-transfer"></i></div><h3 class="font-bold text-sm">Ø´Ø­Ù† Ø±ØµÙŠØ¯</h3></div>
                <div class="bg-white p-4 rounded-xl shadow-sm text-center border border-gray-100 overflow-hidden relative"><div class="bg-yellow-100 w-10 h-10 rounded-full flex items-center justify-center mx-auto mb-2 text-yellow-600"><i class="fa-solid fa-trophy"></i></div><h3 class="font-bold text-sm mb-2">Ø³Ø­ÙˆØ¨Ø§Øª Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h3><div id="fake-profit-ticker" class="h-16 overflow-hidden relative"></div></div>
            </div>
            <div class="mt-6 text-center pb-4 border-t border-gray-200 pt-4"><p class="text-gray-400 text-xs font-bold mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</p><div class="flex justify-center items-center gap-2 text-gray-700"><i class="fa-solid fa-users text-gray-400"></i><p class="text-2xl font-bold" id="fake-user-count">54,230</p></div></div>
        </div>

        <div id="support-page" class="hidden fade-in min-h-screen bg-white p-4 pb-24">
            <div class="flex items-center gap-2 mb-6 pt-4"><i onclick="switchTab('home-page', document.getElementById('nav-home'))" class="fa-solid fa-arrow-right text-xl cursor-pointer"></i><h2 class="font-bold text-xl">Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</h2></div>
            <div id="client-support-history" class="mb-6 space-y-3 max-h-[40vh] overflow-y-auto p-2"></div>
            <div class="border-t border-gray-200 pt-4">
                <label class="block text-sm font-bold mb-2">Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©:</label>
                <textarea id="support-msg-input" rows="3" class="w-full p-3 border rounded-lg mb-2 text-right bg-gray-50" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³ØªÙØ³Ø§Ø±Ùƒ..."></textarea>
                <button onclick="sendSupportMessage()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold shadow hover:bg-purple-700">Ø¥Ø±Ø³Ø§Ù„</button>
                <div class="text-center mt-4 text-gray-400 text-sm">Ø£Ùˆ</div>
                <a id="direct-support-btn" href="#" target="_blank" class="block w-full mt-2 bg-green-100 text-green-700 text-center py-2 rounded-lg font-bold hover:bg-green-200 transition"><i class="fa-brands fa-whatsapp ml-2"></i> ØªÙˆØ§ØµÙ„ Ø®Ø§Ø±Ø¬ÙŠ</a>
            </div>
        </div>

        <div id="signature-page" class="hidden fade-in min-h-screen bg-gray-50 p-4 pb-24"><h2 class="text-center font-bold text-xl mb-6 pt-4 text-gray-800">Ø´Ø±ÙƒØ§Ø¡ Ø§Ù„Ù†Ø¬Ø§Ø­</h2><div id="signature-list" class="space-y-4"></div></div>

        <div id="work-page" class="hidden fade-in min-h-screen bg-[#FFC107] relative pb-24 font-sans">
            <div class="flex justify-between items-center p-4 pt-6 text-black"><div class="w-8"></div><div class="flex items-center gap-2"><span class="font-bold text-xl">Tik Tok Shop</span><div class="bg-white p-1 rounded-md"><i class="fa-brands fa-tiktok text-2xl"></i></div></div></div>
            <div id="sign-alert" class="bg-[#D97706] text-white text-center py-4 px-4 mb-4 shadow-md text-lg font-bold rounded-lg hidden"><i class="fa-solid fa-triangle-exclamation block text-3xl mb-2"></i>âš  ÙŠØ¬Ø¨ ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø¯ Ø£ÙˆÙ„Ø§Ù‹!<br><button onclick="switchTab('signature-page', document.getElementById('nav-sign'))" class="mt-2 bg-black text-white px-4 py-2 rounded text-sm">Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„Ù„ØªÙˆÙ‚ÙŠØ¹</button></div>
            <div id="task-area" class="px-6 transition-all duration-300 relative">
                <div id="frozen-message" class="hidden frozen-overlay text-center p-6 shadow-xl border-2 border-yellow-500"><i class="fa-solid fa-lock text-4xl text-yellow-600 mb-4"></i><h3 class="text-xl font-bold text-gray-800 mb-2">Ø§Ù„Ù…Ù‡Ù…Ø© Ù…ÙƒØªÙ…Ù„Ø©</h3><p class="text-gray-600 text-sm">Ø¬Ø§Ø±ÙŠ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ù…Ø¯ÙŠØ± Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù„ÙØªØ­ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©.</p></div>
                <h3 class="text-right text-white text-lg font-bold mb-4">Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
                <div class="flex justify-between items-start mb-6 bg-white/50 p-4 rounded-2xl backdrop-blur-sm">
                    <div class="text-right w-3/5 pl-2"><p id="task-name" class="text-[#4B3621] font-bold text-sm mb-2 leading-tight">...</p><p class="text-white font-bold text-lg dir-ltr text-right drop-shadow-md">Ù…Ø·Ù„ÙˆØ¨: <span id="task-price">0</span> EGP</p></div>
                    <div class="w-24 h-24 bg-white rounded-xl p-1 shadow-md overflow-hidden"><img id="task-img" src="" class="w-full h-full object-cover rounded-lg"></div>
                </div>
                <div class="grid grid-cols-1 gap-4 text-center mb-8">
                     <div class="bg-[#4B3621]/10 rounded-lg p-2"><span class="block text-[#4B3621] text-xs font-bold">Ø±Ù‚Ù… Ø§Ù„Ù…Ù‡Ù…Ø©</span><span id="task-counter" class="text-white text-xl font-bold">0 / 24</span></div>
                     <div class="flex justify-between gap-2">
                        <div class="bg-[#4B3621]/10 rounded-lg p-2 w-1/2"><span class="block text-[#4B3621] text-xs font-bold">Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</span><span id="task-commission" class="text-white text-lg font-bold dir-ltr">0</span></div>
                        <div class="bg-[#4B3621]/10 rounded-lg p-2 w-1/2"><span class="block text-[#4B3621] text-xs font-bold">Ø±ØµÙŠØ¯Ùƒ</span><span id="task-user-bal" class="text-white text-lg font-bold dir-ltr">0</span></div>
                    </div>
                </div>
            </div>
            <div class="px-6"><button id="work-btn" onclick="processTask()" class="w-full bg-white text-[#4B3621] font-bold py-4 rounded-full shadow-lg active:scale-95 transition text-lg">Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„</button></div>
        </div>

        <div id="profile-page" class="hidden fade-in min-h-screen bg-[#FCD34D] pb-24 font-sans">
            <div class="flex justify-between items-center p-4 pt-6"><div class="w-8"></div><div class="flex items-center gap-2"><span class="text-sm text-[#5D4037] font-bold">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</span><span class="font-bold text-lg text-black">TikTok Shop</span></div></div>
            <div class="flex justify-between px-8 mb-4 text-[#5D4037] items-center">
                <div class="text-right"><span id="profile-name" class="block text-2xl font-bold text-black mb-1"></span><div class="flex items-center gap-2 mb-2"><span class="text-xs font-bold bg-black text-white px-2 py-1 rounded">ID: <span id="profile-uid">...</span></span><span class="text-xs text-black/60 bg-white/40 px-2 py-1 rounded-full border border-black/10">VIP 1</span></div><div class="bg-white/30 backdrop-blur-sm p-2 rounded-lg inline-block border border-white/40 shadow-sm"><p class="text-[10px] font-bold mb-1 text-[#5D4037]">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</p><div id="profile-stars" class="flex gap-1 text-sm"></div></div></div>
                <div class="w-20 h-20 bg-white rounded-full border-4 border-white shadow-md flex items-center justify-center overflow-hidden"><i class="fa-solid fa-user text-4xl text-gray-300"></i></div>
            </div>
            <div class="mx-4 mb-4 bg-black/80 backdrop-blur-sm rounded-xl p-4 flex justify-between items-center shadow-lg border border-yellow-500/30">
                <div class="flex items-center gap-3"><div class="bg-yellow-500 p-2 rounded-full text-black w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-bell"></i></div><div class="text-right"><p class="text-white font-bold text-sm">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ù‡Ø§Ù…</p><p class="text-gray-300 text-[10px]">ØªØ°ÙƒÙŠØ± Ø¨Ø¯ÙØ¹ Ø§Ù„Ù…Ù‡Ø§Ù… Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</p></div></div>
                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" name="toggle" id="notif-toggle" onchange="toggleNotifications(this)" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300 left-0 transition-all duration-300"/><label for="notif-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer transition-all duration-300"></label></div>
            </div>
            <div class="mx-4 bg-white/25 rounded-2xl p-5 shadow-sm backdrop-blur-sm text-[#5D4037] border border-white/20">
                <div class="flex justify-between items-center border-b border-yellow-800/10 py-3"><span class="font-bold text-2xl">Â£ <span id="profile-balance">0.00</span></span><span class="font-bold text-sm opacity-80">Ø§Ù„Ø±ØµÙŠØ¯</span></div>
                <div class="flex justify-between items-center py-3"><span class="font-bold text-xl">Â£ <span id="profile-total-income">0.00</span></span><span class="font-bold text-sm opacity-80">Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</span></div>
            </div>
            <div class="flex gap-4 px-4 mt-6 mb-6"><button onclick="attemptWithdraw()" class="flex-1 bg-black/80 text-white font-bold py-3 rounded-xl shadow-lg">Ø³Ø­Ø¨</button><button onclick="openRechargeModal()" class="flex-1 bg-white text-[#FCD34D] font-bold py-3 rounded-xl shadow-lg">Ø´Ø­Ù†</button></div>
            <div class="px-6 mt-8"><button onclick="logout()" class="w-full border-2 border-red-500 text-red-600 font-bold py-3 rounded-full hover:bg-red-500 hover:text-white transition">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button></div>
        </div>

        <div id="history-page" class="hidden fade-in min-h-screen bg-white pb-24"><div class="text-center text-gray-300 mt-20"><i class="fa-regular fa-folder-open text-5xl mb-4 opacity-50"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</p></div></div>
    </div>

    <nav id="bottom-nav" class="hidden fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 flex justify-around py-3 pb-6 z-40 shadow-[0_-5px_10px_rgba(0,0,0,0.05)]">
        <div id="nav-home" onclick="switchTab('home-page', this)" class="nav-item active text-center cursor-pointer px-4"><i class="fa-solid fa-house text-xl mb-1"></i><div class="text-[10px] font-bold">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div></div>
        <div id="nav-sign" onclick="switchTab('signature-page', this)" class="nav-item text-center cursor-pointer px-4"><i class="fa-solid fa-file-signature text-xl mb-1"></i><div class="text-[10px] font-bold">Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</div></div>
        <div id="nav-work" onclick="switchTab('work-page', this)" class="nav-item text-center cursor-pointer px-4 relative"><div class="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-[#FCD34D] w-12 h-12 rounded-full flex items-center justify-center border-4 border-white shadow-lg"><i class="fa-solid fa-briefcase text-white text-lg"></i></div><div class="mt-7 text-[10px] font-bold">Ø§Ù„Ø¹Ù…Ù„</div></div>
        <div id="nav-hist" onclick="switchTab('history-page', this)" class="nav-item text-center cursor-pointer px-4"><i class="fa-solid fa-clock-rotate-left text-xl mb-1"></i><div class="text-[10px] font-bold">Ø§Ù„Ø³Ø¬Ù„</div></div>
        <div id="nav-prof" onclick="switchTab('profile-page', this)" class="nav-item text-center cursor-pointer px-4"><i class="fa-solid fa-user text-xl mb-1"></i><div class="text-[10px] font-bold">Ø­Ø³Ø§Ø¨ÙŠ</div></div>
    </nav>

    <script>
        let tasks = [];
        let currentUser = null;
        let allUsers = [];
        let allRequests = [];
        let supportMessages = [];
        let siteSettings = {};
        let signatures = [];
        let generatedOtp = null;
        let registeringPhone = null;
        let currentRechargeImage = null;
        let notificationInterval = null;
        const beepSound = new Audio('https://www.soundjay.com/buttons/beep-01a.mp3'); 
        let adminStartTime = 0; 

        function initializeAppLogic() {
            setTimeout(() => {
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('hidden');

                const tasksRef = window.ref(window.db, 'tasks');
                window.onValue(tasksRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data && data.length >= 24) tasks = data;
                    else {
                        let generatedTasks = [];
                        for(let i=1; i<=24; i++) {
                            let p = i * 100;
                            generatedTasks.push({ id: i, name: `Ù…Ù‡Ù…Ø© ØªØ¬Ø§Ø±ÙŠØ© Ø±Ù‚Ù… ${i}`, price: p, commission: (p*0.10), img: `https://source.unsplash.com/random/200x200?product&sig=${i}` });
                        }
                        window.set(tasksRef, generatedTasks);
                        tasks = generatedTasks;
                    }
                    if(!document.getElementById('admin-panel').classList.contains('hidden')) renderAdminTasksUI();
                });

                window.onValue(window.ref(window.db, 'signatures'), (snapshot) => {
                    const data = snapshot.val();
                    if (data) signatures = data;
                    else {
                        signatures = [{ name: "Business Plan", price: 300 }, { name: "Extra Plan", price: 500 }, { name: "Bonanza VIP", price: 800 }];
                        window.set(window.ref(window.db, 'signatures'), signatures);
                    }
                    renderSignatures();
                    if(!document.getElementById('admin-panel').classList.contains('hidden')) renderAdminSignaturesUI();
                });

                window.onValue(window.ref(window.db, 'users'), (snapshot) => {
                    if (snapshot.val()) {
                        allUsers = Object.values(snapshot.val());
                        if(!document.getElementById('admin-panel').classList.contains('hidden')) renderAdminUsersUI();
                    }
                });

                window.onValue(window.ref(window.db, 'settings'), (snapshot) => {
                    siteSettings = snapshot.val() || { vodafoneCashNumber: '01000000000', siteAnnouncement: 'Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ', supportLink: '#' };
                    updateClientSettingsUI();
                });

                window.onValue(window.ref(window.db, 'recharge_requests'), (snapshot) => {
                    if (snapshot.val()) allRequests = Object.entries(snapshot.val()).map(([key, value]) => ({ id: key, ...value }));
                    if(!document.getElementById('admin-panel').classList.contains('hidden')) renderAdminRequestsUI();
                });

                window.onValue(window.ref(window.db, 'support_messages'), (snapshot) => {
                    if (snapshot.val()) {
                        supportMessages = Object.entries(snapshot.val()).map(([key, value]) => ({ id: key, ...value }));
                        if(currentUser && !document.getElementById('client-app').classList.contains('hidden')) renderClientSupportHistory();
                    }
                    if(!document.getElementById('admin-panel').classList.contains('hidden')) renderAdminSupportUI();
                });

                startFakeTicker();
                startImageSlider();
                startFakeUserCount();
            }, 1000);
        }

        function updateClientSettingsUI() {
            if(document.getElementById('recharge-admin-number')) document.getElementById('recharge-admin-number').innerText = siteSettings.vodafoneCashNumber;
            if(document.getElementById('announcement-display-text')) document.getElementById('announcement-display-text').innerText = siteSettings.siteAnnouncement;
            if(document.getElementById('direct-support-btn')) document.getElementById('direct-support-btn').href = siteSettings.supportLink || '#';
        }

        window.copyToClipboard = function() {
            const numText = document.getElementById('recharge-admin-number').innerText;
            navigator.clipboard.writeText(numText).then(() => {
                const icon = document.getElementById('copy-icon');
                if(icon) {
                    icon.className = "fa-solid fa-check text-green-500 text-xl";
                    setTimeout(() => { icon.className = "fa-regular fa-copy text-gray-500 text-xl"; }, 2000);
                }
            }).catch(err => console.error(err));
        }

        function startFakeTicker() {
            const container = document.getElementById('fake-profit-ticker');
            if(!container) return;
            setInterval(() => {
                const prefix = ['010', '011', '012', '015'][Math.floor(Math.random() * 4)];
                const suffix = Math.floor(Math.random() * 9000) + 1000;
                const fakePhone = `${prefix}****${suffix}`;
                const fakeAmount = (Math.floor(Math.random() * 45) + 5) * 100;
                const item = document.createElement('div');
                item.className = 'ticker-item text-[10px] text-gray-600 flex justify-between px-2 mb-1';
                item.innerHTML = `<span>${fakePhone}</span> <span class="text-green-600 font-bold">+${fakeAmount} EGP</span>`;
                container.prepend(item);
                if(container.children.length > 3) container.lastElementChild.remove();
            }, 2000);
        }

        function startImageSlider() {
            let currentSlide = 0;
            const slides = document.querySelectorAll('.slider-container .slide');
            if(slides.length === 0) return;
            setInterval(() => {
                slides[currentSlide].classList.remove('active');
                currentSlide = (currentSlide + 1) % slides.length;
                slides[currentSlide].classList.add('active');
            }, 3000);
        }

        function startFakeUserCount() {
            const element = document.getElementById('fake-user-count');
            let count = 54230; 
            if(!element) return;
            element.innerText = count.toLocaleString();
            setInterval(() => {
                count += Math.floor(Math.random() * 3) + 1;
                element.innerText = count.toLocaleString();
            }, 4000);
        }

        window.toggleAuth = function(type) {
            document.getElementById(type === 'login' ? 'login-form' : 'reg-form').classList.remove('hidden');
            document.getElementById(type === 'login' ? 'reg-form' : 'login-form').classList.add('hidden');
        }

        window.sendOtp = function() {
            registeringPhone = document.getElementById('reg-phone').value;
            if(!registeringPhone || registeringPhone.length < 10) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­");
            window.get(window.ref(window.db, 'users/' + registeringPhone)).then(snap => {
                if(snap.exists()) {
                    alert("Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„! ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.");
                    window.toggleAuth('login');
                } else {
                    generatedOtp = Math.floor(1000 + Math.random() * 9000);
                    alert(`(Ù…Ø­Ø§ÙƒØ§Ø© SMS) ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù‡Ùˆ: ${generatedOtp}`);
                    document.getElementById('reg-step-1').classList.add('hidden');
                    document.getElementById('reg-step-2').classList.remove('hidden');
                }
            });
        }

        window.verifyOtp = function() {
            const inputOtp = document.getElementById('reg-otp-input').value;
            if(inputOtp == generatedOtp) {
                document.getElementById('reg-step-2').classList.add('hidden');
                document.getElementById('reg-step-3').classList.remove('hidden');
            } else {
                alert("ÙƒÙˆØ¯ Ø®Ø§Ø·Ø¦! Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
            }
        }

        window.resendOtp = function() {
            generatedOtp = Math.floor(1000 + Math.random() * 9000);
            alert(`(Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„) ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‡Ùˆ: ${generatedOtp}`);
        }

        window.completeRegistration = function() {
            const name = document.getElementById('reg-name').value;
            const dob = document.getElementById('reg-dob').value;
            const pass = document.getElementById('reg-pass').value;
            const passConfirm = document.getElementById('reg-pass-confirm').value;
            if(!name || !dob || !pass || !passConfirm) return alert("Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ù„ÙˆØ¨Ø©");
            if(pass !== passConfirm) return alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØªØ£ÙƒÙŠØ¯Ù‡Ø§ ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ÙŠÙ†");
            const generatedUID = Math.floor(100000 + Math.random() * 900000);
            const userRef = window.ref(window.db, 'users/' + registeringPhone);
            window.set(userRef, { 
                name, phone: registeringPhone, uid: generatedUID, dob: dob, password: pass, 
                balance: 0, totalIncome: 0, currentTaskIndex: 1, isTaskFrozen: false, 
                isSigned: false, isBanned: false, notificationsEnabled: false
            }).then(() => { 
                alert(`ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨Ùƒ Ù‡Ùˆ: ${generatedUID}`); 
                window.toggleAuth('login'); 
                document.getElementById('reg-step-3').classList.add('hidden');
                document.getElementById('reg-step-1').classList.remove('hidden');
            });
        }

        window.loginUser = function() {
            const phone = document.getElementById('login-phone').value;
            const pass = document.getElementById('login-pass').value;
            if(phone === 'admin' && pass === 'mohy123') {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                
                // REQUEST BROWSER NOTIFICATION PERMISSION ON LOGIN
                if (Notification.permission !== "granted") {
                    Notification.requestPermission();
                }

                enableAdminRealtimeAlerts();
                showAdminTab('users');
                return;
            }
            const userRef = window.ref(window.db, 'users/' + phone);
            window.get(userRef).then((snap) => {
                if(snap.exists() && snap.val().password === pass) {
                    const userData = snap.val();
                    if(userData.isBanned) return alert("â›” ØªÙ… Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨Ùƒ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.");
                    if(!userData.uid) {
                        const newUID = Math.floor(100000 + Math.random() * 900000);
                        window.update(userRef, { uid: newUID });
                        userData.uid = newUID;
                    }
                    currentUser = userData;
                    window.onValue(userRef, (userSnap) => { 
                        currentUser = userSnap.val(); 
                        if(currentUser) { updateAppUI(); handleNotificationLogic(); }
                    });
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('client-app').classList.remove('hidden');
                    document.getElementById('bottom-nav').classList.remove('hidden');
                    updateAppUI();
                } else alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            });
        }
        
        window.logout = function() { 
            if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) location.reload(); 
        }

        // --- Client Logic ---
        function updateAppUI() {
            if(currentUser.isBanned) { alert("ØªÙ… Ø­Ø¸Ø±Ùƒ"); location.reload(); return; }
            document.getElementById('profile-name').innerText = currentUser.name;
            document.getElementById('profile-uid').innerText = currentUser.uid || currentUser.phone;
            const toggleBtn = document.getElementById('notif-toggle');
            if(toggleBtn) toggleBtn.checked = currentUser.notificationsEnabled || false;
            const completedTasks = currentUser.currentTaskIndex - 1; 
            const progress = Math.min(1, Math.max(0, completedTasks / 24));
            const starValue = progress * 5; 
            let starsHTML = '';
            for (let i = 1; i <= 5; i++) {
                if (starValue >= i) starsHTML += '<i class="fa-solid fa-star text-yellow-400"></i>'; 
                else if (starValue >= i - 0.5) starsHTML += '<i class="fa-solid fa-star-half-stroke text-yellow-400"></i>'; 
                else starsHTML += '<i class="fa-solid fa-star text-gray-300"></i>'; 
            }
            document.getElementById('profile-stars').innerHTML = starsHTML;
            document.getElementById('profile-balance').innerText = currentUser.balance.toFixed(2);
            document.getElementById('profile-total-income').innerText = currentUser.totalIncome.toFixed(2);
            renderClientSupportHistory();
            updateWorkPage();
        }

        window.toggleNotifications = function(checkbox) {
            if(!currentUser) return;
            window.update(window.ref(window.db, 'users/' + currentUser.phone), { notificationsEnabled: checkbox.checked }).then(() => {
                if(checkbox.checked) { alert("âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª! Ø³Ù†Ø°ÙƒØ±Ùƒ Ø¨Ø§Ù„Ù…Ù‡Ø§Ù…."); beepSound.play().catch(e => console.log("Audio play blocked")); }
            });
        }

        function handleNotificationLogic() {
            if(notificationInterval) clearInterval(notificationInterval);
            if(currentUser && currentUser.notificationsEnabled) {
                notificationInterval = setInterval(() => { showNotificationToast(); }, 15000); 
            }
        }

        function showNotificationToast() {
            const messages = [`âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ù…Ù‡Ù…Ø© Ø±Ù‚Ù… ${currentUser.currentTaskIndex} ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø±Ùƒ!`, `ğŸ’° Ù„Ø§ ØªØ¶ÙŠØ¹ Ø£Ø±Ø¨Ø§Ø­Ùƒ! Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†.`, `â³ Ø§Ù„ÙˆÙ‚Øª ÙŠÙ…Ø±! Ø±ØµÙŠØ¯Ùƒ Ù…Ø¹Ù„Ù‚ Ø­ØªÙ‰ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ù…Ù‡Ø§Ù….`];
            const randomMsg = messages[Math.floor(Math.random() * messages.length)];
            const toast = document.getElementById('notification-toast');
            document.getElementById('notif-text').innerText = randomMsg;
            beepSound.play().catch(e => console.log("Audio blocked by browser"));
            toast.classList.remove('hidden'); toast.classList.add('top-4');
            setTimeout(() => { toast.classList.add('hidden'); }, 5000);
        }

        // ============================================
        // === ADMIN REALTIME WATCHTOWER WITH BROWSER NOTIFICATIONS ===
        // ============================================
        function enableAdminRealtimeAlerts() {
            adminStartTime = Date.now(); 

            window.onChildAdded(window.ref(window.db, 'recharge_requests'), (snapshot) => {
                const req = snapshot.val();
                if (req.timestamp && req.timestamp > adminStartTime) {
                    const msg = `ğŸ’¸ Ø·Ù„Ø¨ Ø´Ø­Ù† Ø¬Ø¯ÙŠØ¯: ${req.amount}Ø¬ Ù…Ù† ${req.senderName}`;
                    showAdminAlert(msg, "go-requests");
                    sendSystemNotification("Ø·Ù„Ø¨ Ø´Ø­Ù† Ø¬Ø¯ÙŠØ¯", msg);
                }
            });

            window.onChildChanged(window.ref(window.db, 'users'), (snapshot) => {
                const user = snapshot.val();
                if (user.isTaskFrozen === true) {
                    const msg = `ğŸ”’ ${user.name} Ø£Ù†Ù‡Ù‰ Ù…Ù‡Ù…Ø© ÙˆÙŠÙ†ØªØ¸Ø± Ø§Ù„ÙØªØ­!`;
                    showAdminAlert(msg, "go-users");
                    sendSystemNotification("Ù…Ù‡Ù…Ø© Ù…ÙƒØªÙ…Ù„Ø©", msg);
                }
            });

             window.onChildAdded(window.ref(window.db, 'users'), (snapshot) => {
                if (Date.now() > adminStartTime + 3000) { 
                    const user = snapshot.val();
                    const msg = `ğŸ‘¤ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†: ${user.name}`;
                    showAdminAlert(msg, "go-users");
                    sendSystemNotification("Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯", msg);
                }
            });
        }

        function showAdminAlert(message, action) {
            const container = document.getElementById('admin-alerts-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = 'admin-toast cursor-pointer hover:bg-gray-700';
            alertDiv.innerHTML = `<i class="fa-solid fa-bell text-yellow-400 text-xl animate-swing"></i> <div><p class="font-bold text-sm">ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø¨Ø§Ø´Ø±</p><p class="text-xs text-gray-300">${message}</p></div>`;
            beepSound.play().catch(e => console.log("Audio error"));
            alertDiv.onclick = function() {
                if(action === 'go-requests') showAdminTab('requests');
                if(action === 'go-users') showAdminTab('users');
                alertDiv.remove();
            };
            container.appendChild(alertDiv);
            setTimeout(() => { if(container.contains(alertDiv)) alertDiv.remove(); }, 8000);
        }

        function sendSystemNotification(title, body) {
            if (Notification.permission === "granted") {
                const notif = new Notification(title, {
                    body: body,
                    icon: "https://cdn-icons-png.flaticon.com/512/1827/1827349.png"
                });
                notif.onclick = function() {
                    window.focus();
                    notif.close();
                };
            }
        }
        // ============================================

        // --- Signatures ---
        function renderSignatures() {
            const container = document.getElementById('signature-list');
            if(container) {
                container.innerHTML = '';
                signatures.forEach(m => {
                    const bg = m.img ? `style="background-image: url('${m.img}'); background-size: cover;"` : '';
                    container.innerHTML += `<div class="bg-white p-4 rounded-xl shadow-md border border-gray-200 flex flex-col gap-2 relative overflow-hidden" ${bg}><div class="absolute top-0 left-0 bg-yellow-400 w-1 h-full"></div><div class="flex justify-between items-center relative z-10"><h3 class="font-bold text-lg text-gray-800 bg-white/80 px-2 rounded">${m.name}</h3><span class="bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded-full border border-green-200">${m.price} EGP</span></div><button onclick="signContract('${m.name}', ${m.price})" class="bg-black text-white py-3 rounded-lg text-sm font-bold mt-2 hover:bg-gray-800 transition shadow-lg relative z-10">ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨</button></div>`;
                });
            }
        }

        window.signContract = function(merchantName, price) {
            if (currentUser.balance < price) { alert(`Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ.\nÙ…Ø·Ù„ÙˆØ¨: ${price}Ø¬\nØ±ØµÙŠØ¯Ùƒ: ${currentUser.balance}Ø¬\nÙŠØ±Ø¬Ù‰ Ø§Ù„Ø´Ø­Ù†.`); openRechargeModal(); return; }
            if(confirm(`Ø®ØµÙ… ${price}Ø¬ Ù„Ù„Ø§Ø´ØªØ±Ø§ÙƒØŸ`)) { window.update(window.ref(window.db, 'users/' + currentUser.phone), { isSigned: true, balance: currentUser.balance - price }).then(() => { alert("âœ… ØªÙ… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ!"); window.switchTab('work-page', document.getElementById('nav-work')); }); }
        }

        window.attemptWithdraw = function() { if (currentUser.currentTaskIndex <= 24) return alert(`â›” Ø®Ø·Ø£!\nÙ„Ù… ØªÙƒÙ…Ù„ 24 Ù…Ù‡Ù…Ø©.`); alert("âœ… ØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨."); }

        function updateWorkPage() {
            const alertBox = document.getElementById('sign-alert'); const workBtn = document.getElementById('work-btn'); const taskArea = document.getElementById('task-area'); const frozenMsg = document.getElementById('frozen-message');
            if (!currentUser || !currentUser.isSigned) { alertBox.classList.remove('hidden'); workBtn.innerText = "ÙŠØ¬Ø¨ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹"; workBtn.disabled = true; workBtn.classList.add('opacity-50'); taskArea.classList.add('opacity-50', 'blur-sm'); return; }
            alertBox.classList.add('hidden'); taskArea.classList.remove('opacity-50', 'blur-sm');
            if (currentUser.isTaskFrozen) { frozenMsg.classList.remove('hidden'); workBtn.innerText = "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¯ÙŠØ±..."; workBtn.disabled = true; workBtn.classList.add('bg-gray-400'); return; } else frozenMsg.classList.add('hidden');
            const taskIndex = currentUser.currentTaskIndex - 1;
            if (taskIndex >= tasks.length) { workBtn.innerText = "ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ù‡Ø§Ù…"; workBtn.disabled = true; return; }
            const currentTask = tasks[taskIndex];
            workBtn.disabled = false; workBtn.classList.remove('bg-gray-400', 'opacity-50'); workBtn.innerText = "Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„";
            document.getElementById('task-img').src = currentTask.img; document.getElementById('task-name').innerText = currentTask.name; document.getElementById('task-price').innerText = currentTask.price;
            document.getElementById('task-counter').innerText = `${currentUser.currentTaskIndex} / 24`; document.getElementById('task-commission').innerText = currentTask.commission || 0; document.getElementById('task-user-bal').innerText = currentUser.balance.toFixed(2);
        }

        window.processTask = function() {
            const currentTask = tasks[currentUser.currentTaskIndex - 1];
            if (currentUser.balance < currentTask.price) { alert(`Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ! Ù…Ø·Ù„ÙˆØ¨ ${currentTask.price}Ø¬.`); openRechargeModal(); return; }
            const btn = document.getElementById('work-btn'); btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ...'; btn.disabled = true;
            setTimeout(() => {
                const commission = parseFloat(currentTask.commission);
                window.update(window.ref(window.db, 'users/' + currentUser.phone), { balance: currentUser.balance + commission, totalIncome: currentUser.totalIncome + commission, isTaskFrozen: true }).then(() => { alert(`âœ… Ø±Ø¨Ø­Øª ${commission}Ø¬!`); updateWorkPage(); });
            }, 2000);
        }

        // --- File Upload ---
        window.openRechargeModal = function() { document.getElementById('recharge-modal').classList.remove('hidden'); }
        window.closeRechargeModal = function() { document.getElementById('recharge-modal').classList.add('hidden'); currentRechargeImage = null; document.getElementById('upload-placeholder').classList.remove('hidden'); document.getElementById('upload-preview').classList.add('hidden'); }
        window.handleFileUpload = function(input) { if (input.files && input.files[0]) { const file = input.files[0]; const reader = new FileReader(); reader.onload = function(e) { currentRechargeImage = e.target.result; document.getElementById('upload-placeholder').classList.add('hidden'); document.getElementById('upload-preview').classList.remove('hidden'); }; reader.readAsDataURL(file); } }
        window.submitRechargeRequest = function() {
            const amount = document.getElementById('charge-amount').value; const sender = document.getElementById('charge-sender').value; const name = document.getElementById('charge-name').value;
            if(!amount || !sender || !name) return alert("Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©"); if(!currentRechargeImage) return alert("ÙŠØ¬Ø¨ Ø±ÙØ¹ Ø³ÙƒØ±ÙŠÙ† Ø´ÙˆØª!");
            window.push(window.ref(window.db, 'recharge_requests'), { userPhone: currentUser.phone, senderName: name, amount: parseFloat(amount), senderNumber: sender, screenshot: currentRechargeImage, status: 'pending', timestamp: Date.now() }).then(() => { alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„!"); closeRechargeModal(); });
        }

        window.sendSupportMessage = function() { const msg = document.getElementById('support-msg-input').value; if(!msg) return alert("Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©"); window.push(window.ref(window.db, 'support_messages'), { userPhone: currentUser.phone, userName: currentUser.name, message: msg, timestamp: Date.now(), reply: null }).then(() => { document.getElementById('support-msg-input').value = ''; renderClientSupportHistory(); }); }
        function renderClientSupportHistory() { const container = document.getElementById('client-support-history'); if(!container || !currentUser) return; container.innerHTML = ''; const myMsgs = supportMessages.filter(m => m.userPhone === currentUser.phone).sort((a,b) => a.timestamp - b.timestamp); if(myMsgs.length === 0) { container.innerHTML = '<p class="text-center text-gray-400 text-sm mt-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø³Ø§Ø¨Ù‚Ø©</p>'; return; } myMsgs.forEach(msg => { container.innerHTML += `<div class="msg-bubble-user"><strong>Ø£Ù†Øª:</strong> ${msg.message}</div>`; if(msg.reply) container.innerHTML += `<div class="msg-bubble-admin"><strong>Ø§Ù„Ø¯Ø¹Ù…:</strong> ${msg.reply}</div>`; }); container.scrollTop = container.scrollHeight; }

        // --- Admin Tabs ---
        window.showAdminTab = function(tab) {
            ['users', 'tasks', 'requests', 'settings', 'support', 'signatures'].forEach(t => { document.getElementById(`admin-${t}-sec`).classList.add('hidden'); if(document.getElementById(`btn-tab-${t}`)) document.getElementById(`btn-tab-${t}`).classList.remove('bg-yellow-600', 'bg-blue-600', 'bg-green-600', 'bg-purple-600', 'bg-orange-600'); if(document.getElementById(`btn-tab-${t}`)) document.getElementById(`btn-tab-${t}`).classList.add('bg-gray-700'); });
            document.getElementById(`admin-${tab}-sec`).classList.remove('hidden');
            let color = 'bg-gray-700'; if(tab === 'users') color = 'bg-yellow-600'; if(tab === 'requests') color = 'bg-blue-600'; if(tab === 'support') color = 'bg-purple-600'; if(tab === 'signatures') color = 'bg-orange-600';
            if(document.getElementById(`btn-tab-${tab}`)) { document.getElementById(`btn-tab-${tab}`).classList.remove('bg-gray-700'); document.getElementById(`btn-tab-${tab}`).classList.add(color); }
            if(tab === 'users') renderAdminUsersUI(); if(tab === 'tasks') renderAdminTasksUI(); if(tab === 'requests') renderAdminRequestsUI(); if(tab === 'support') renderAdminSupportUI(); if(tab === 'settings') renderAdminSettingsUI(); if(tab === 'signatures') renderAdminSignaturesUI();
        }

        function renderAdminUsersUI() {
            let html = ''; allUsers.forEach(user => { const actionBtn = user.isTaskFrozen ? `<button onclick="unlockNextTask('${user.phone}', ${user.currentTaskIndex})" class="bg-yellow-500 text-black admin-btn animate-pulse">ğŸ”“ ÙØªØ­ Ø§Ù„Ù…Ù‡Ù…Ø© ${user.currentTaskIndex + 1}</button>` : `<span class="text-gray-400 text-[10px]">ÙŠØ¹Ù…Ù„..</span>`; const banBtn = user.isBanned ? `<button onclick="unbanUser('${user.phone}')" class="bg-gray-500 admin-btn">ÙÙƒ Ø§Ù„Ø­Ø¸Ø±</button>` : `<button onclick="banUser('${user.phone}')" class="bg-red-800 admin-btn">ğŸš« Ø­Ø¸Ø±</button>`; html += `<tr class="bg-gray-700/30"><td>${user.name}<br><span class="text-xs text-gray-400">${user.phone}</span></td><td class="text-green-400">${user.balance}</td><td>${user.isBanned ? '<span class="text-red-600 font-bold">Ù…Ø­Ø¸ÙˆØ±</span>' : '<span class="text-green-400">Ù†Ø´Ø·</span>'}</td><td>${actionBtn} <br><button onclick="editUserBalance('${user.phone}', ${user.balance})" class="bg-blue-600 admin-btn">ØªØ¹Ø¯ÙŠÙ„</button>${banBtn}<button onclick="deleteUser('${user.phone}')" class="bg-red-600 admin-btn">ğŸ—‘ï¸ Ø­Ø°Ù</button></td></tr>`; }); document.getElementById('admin-users-list').innerHTML = html;
        }
        window.unlockNextTask = function(phone, currentIndex) { if(confirm(`ÙØªØ­ Ø§Ù„Ù…Ù‡Ù…Ø© ${currentIndex + 1}ØŸ`)) window.update(window.ref(window.db, `users/${phone}`), { isTaskFrozen: false, currentTaskIndex: currentIndex + 1 }).then(() => { alert("ØªÙ…!"); renderAdminUsersUI(); }); }
        window.banUser = function(phone) { if(confirm("Ø­Ø¸Ø±ØŸ")) window.update(window.ref(window.db, `users/${phone}`), { isBanned: true }).then(() => { alert("ØªÙ…"); renderAdminUsersUI(); }); }
        window.unbanUser = function(phone) { if(confirm("ÙÙƒØŸ")) window.update(window.ref(window.db, `users/${phone}`), { isBanned: false }).then(() => { alert("ØªÙ…"); renderAdminUsersUI(); }); }
        window.deleteUser = function(phone) { if(confirm("Ø­Ø°ÙØŸ")) window.remove(window.ref(window.db, `users/${phone}`)).then(() => { alert("ØªÙ…"); }); }

        function renderAdminTasksUI() { const container = document.getElementById('admin-tasks-container'); container.innerHTML = ''; tasks.forEach((task, index) => { container.innerHTML += `<div class="bg-gray-700 p-2 rounded flex items-center gap-2"><span class="text-yellow-500 w-6">${index+1}</span><input type="text" id="task-name-${index}" value="${task.name}" class="bg-gray-600 text-white p-1 rounded text-xs flex-1"><input type="number" id="task-price-${index}" value="${task.price}" class="bg-gray-900 text-green-400 p-1 rounded w-20 border border-green-600"><input type="number" id="task-comm-${index}" value="${task.commission}" class="bg-gray-900 text-yellow-400 p-1 rounded w-20 border border-yellow-600"><input type="text" id="task-img-${index}" value="${task.img}" class="bg-gray-900 text-white p-1 rounded text-xs w-1/4"></div>`; }); }
        window.saveAdminTasks = function() { let updated = []; for(let i=0; i<tasks.length; i++) { updated.push({ id: i+1, name: document.getElementById(`task-name-${i}`).value, price: parseFloat(document.getElementById(`task-price-${i}`).value), commission: parseFloat(document.getElementById(`task-comm-${i}`).value), img: document.getElementById(`task-img-${i}`).value }); } window.set(window.ref(window.db, 'tasks'), updated).then(() => alert("ØªÙ…!")); }

        function renderAdminSignaturesUI() { const container = document.getElementById('admin-signatures-container'); container.innerHTML = ''; signatures.forEach((sig, index) => { container.innerHTML += `<div class="bg-gray-700 p-2 rounded flex items-center gap-2 mb-2"><input type="text" id="sig-name-${index}" value="${sig.name}" class="bg-gray-600 text-white p-1 rounded text-xs flex-1"><input type="number" id="sig-price-${index}" value="${sig.price}" class="bg-gray-900 text-green-400 p-1 rounded w-20 border border-green-600"><input type="text" id="sig-img-${index}" value="${sig.img || ''}" class="bg-gray-900 text-white p-1 rounded text-xs w-1/4"><button onclick="deleteSignature(${index})" class="bg-red-600 text-white px-2 rounded">X</button></div>`; }); }
        window.saveAdminSignatures = function() { let updated = []; const rows = document.getElementById('admin-signatures-container').children; for(let i=0; i<rows.length; i++) { if(document.getElementById(`sig-name-${i}`)) { updated.push({ name: document.getElementById(`sig-name-${i}`).value, price: parseFloat(document.getElementById(`sig-price-${i}`).value), img: document.getElementById(`sig-img-${i}`).value }); } } window.set(window.ref(window.db, 'signatures'), updated).then(() => alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª!")); }
        window.addNewSignature = function() { signatures.push({ name: "Ø¨Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©", price: 0, img: "" }); renderAdminSignaturesUI(); }
        window.deleteSignature = function(index) { signatures.splice(index, 1); renderAdminSignaturesUI(); }

        function renderAdminRequestsUI() { let html = ''; allRequests.filter(r => r.status === 'pending').forEach(req => { let viewImgBtn = req.screenshot ? `<button onclick="openImageWindow(window['img_${req.id}'])" class="bg-purple-600 admin-btn ml-1">ğŸ“¸ Ø¹Ø±Ø¶ Ø§Ù„Ø¥ÙŠØµØ§Ù„</button>` : `<span class="text-gray-500 text-[10px]">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©</span>`; if(req.screenshot) window['img_' + req.id] = req.screenshot; html += `<tr><td>${req.senderName}<br><span class="text-[10px] text-gray-400">${req.userPhone}</span></td><td class="text-green-400">${req.amount}</td><td>${req.senderNumber}</td><td><button onclick="approveReq('${req.id}','${req.userPhone}',${req.amount})" class="bg-green-600 admin-btn">âœ…</button><button onclick="rejectReq('${req.id}')" class="bg-red-600 admin-btn">âŒ</button><br>${viewImgBtn}</td></tr>`; }); document.getElementById('admin-requests-list').innerHTML = html || '<tr><td colspan="4" class="text-center text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯</td></tr>'; }
        window.openImageWindow = function(base64Data) { const win = window.open(""); win.document.write(`<img src="${base64Data}" style="max-width:100%; height:auto;">`); }
        window.approveReq = function(id, phone, amount) { window.update(window.ref(window.db, `recharge_requests/${id}`), { status: 'approved' }); window.get(window.ref(window.db, `users/${phone}`)).then(s => window.update(window.ref(window.db, `users/${phone}`), { balance: (s.val().balance || 0) + amount }).then(() => alert("ØªÙ…!"))); }
        window.rejectReq = function(id) { const r = prompt("Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶:"); if(r) window.update(window.ref(window.db, `recharge_requests/${id}`), { status: 'rejected', rejectionReason: r }); }

        function renderAdminSupportUI() { let html = ''; supportMessages.sort((a,b) => b.timestamp - a.timestamp).forEach(msg => { let replyStatus = msg.reply ? `<div class="text-[10px] text-green-400 mt-1">âœ… ØªÙ… Ø§Ù„Ø±Ø¯: ${msg.reply}</div>` : `<button onclick="replyToMsg('${msg.id}')" class="bg-blue-500 admin-btn">â†©ï¸ Ø±Ø¯</button>`; html += `<tr class="bg-gray-700/30"><td>${msg.userName}<br><span class="text-[10px] text-gray-400">${msg.userPhone}</span></td><td class="text-sm p-2"><div class="bg-gray-800 p-2 rounded text-white">${msg.message}</div>${replyStatus}</td><td><button onclick="deleteSupportMsg('${msg.id}')" class="bg-red-600 admin-btn">Ø­Ø°Ù</button></td></tr>`; }); document.getElementById('admin-support-list').innerHTML = html || '<tr><td colspan="3" class="text-center text-gray-500">Ù„Ø§ Ø±Ø³Ø§Ø¦Ù„</td></tr>'; }
        window.replyToMsg = function(id) { const reply = prompt("Ø§Ù„Ø±Ø¯:"); if(reply) window.update(window.ref(window.db, `support_messages/${id}`), { reply: reply, replyTime: Date.now() }).then(() => alert("ØªÙ…!")); }
        window.deleteSupportMsg = function(id) { if(confirm("Ø­Ø°ÙØŸ")) window.remove(window.ref(window.db, `support_messages/${id}`)); }

        function renderAdminSettingsUI() { document.getElementById('setting-cash-number').value = siteSettings.vodafoneCashNumber; document.getElementById('setting-announcement').value = siteSettings.siteAnnouncement; document.getElementById('setting-support-link').value = siteSettings.supportLink; }
        window.saveSiteSettings = function() { window.update(window.ref(window.db, 'settings'), { vodafoneCashNumber: document.getElementById('setting-cash-number').value, siteAnnouncement: document.getElementById('setting-announcement').value, supportLink: document.getElementById('setting-support-link').value }).then(() => alert("ØªÙ…!")); }
        window.editUserBalance = function(phone, bal) { const n = prompt("Ø§Ù„Ø±ØµÙŠØ¯:", bal); if(n) window.update(window.ref(window.db, `users/${phone}`), { balance: parseFloat(n) }); }
        
        window.switchTab = function(pageId, navElement) { ['home-page', 'signature-page', 'work-page', 'history-page', 'profile-page', 'support-page'].forEach(id => document.getElementById(id).classList.add('hidden')); document.getElementById(pageId).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('active', 'text-black'); el.classList.add('text-gray-400'); }); if(navElement) { navElement.classList.add('active', 'text-black'); navElement.classList.remove('text-gray-400'); } }
    </script>
</body>
</html>
